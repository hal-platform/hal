#!/usr/bin/env php
<?php

namespace QL\Hal\Bin;

use Zend\Ldap\Dn;

$root = __DIR__ . '/../..';
if (!$container = @include $root . '/configuration/bootstrap.php') {
    echo "Boom goes the dynamite.\n";
    return;
};

// validate args
$cmd = array_shift($argv);
if (count($argv) < 1) {
    echo <<<HELP
Usage: $cmd {LDAP_GROUP_NAME}
Protip: Use quotes if the group has spaces.

HELP;
    exit(1);
}

$group = array_shift($argv);

$ldap = $container->get('ldap');

// deployment permissions
// CN = git-REPO_KEY-ENV_NAME
$dn = Dn::factory([
    ['cn' => $group],
    ['dc' => 'mi'],
    ['dc' => 'corp'],
]);
$users = $ldap->usersInGroup($dn);

echo "\n" . sprintf('Group: "%s"', $group) . "\n";
if (count($users) == 0) {
    echo "No users found.\n";
} else {

    foreach ($users as $user) {
        $id = str_pad($user->commonId(), 15);
        $username = str_pad($user->windowsUsername(), 15);
        $name = str_pad($user->displayName(), 30);

        echo $id, $username, $name;
        echo "\n";
    }
}
