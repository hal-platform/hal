#!/usr/bin/env php
<?php

namespace Hal\Bin;

use Hal\UI\Application\Di;
use Hal\UI\CachedContainer;
use Symfony\Bridge\ProxyManager\LazyProxy\PhpDumper\ProxyDumper;
use Symfony\Component\DependencyInjection\Dumper\PhpDumper;

$root = __DIR__ . '/../';
$file = $root . 'src/CachedContainer.php';
$class = CachedContainer::class;

if (!$autoloader = @include __DIR__ . '/../vendor/autoload.php') {
    echo "An error occured while attempting to dump the DI Container.\n";
    exit(1);
};

$container = Di::buildHalDI($root);

// Manually build the dumper so we can attach the proxydumper to enable lazy services
$dumper = new PhpDumper($container);
$dumper->setProxyDumper(new ProxyDumper);

$exploded = explode('\\', $class);
file_put_contents($file, $dumper->dump([
    'class' => array_pop($exploded),
    'namespace' => implode('\\', $exploded)
]));

echo <<<OUTPUT
Dumping DI Container cache:
File: $file
Class: $class

OUTPUT;
