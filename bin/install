#!/usr/bin/env bash

function loadTitles() {
    read -r -d '' TITLE_COMPOSER <<OUTOUT
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ COMPOSER INSTALLATION                                                        ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
OUTOUT
    read -r -d '' TITLE_NPM <<OUTOUT
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ NPM INSTALLATION                                                             ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
OUTOUT
}

# setup

loadTitles
DIR=$( cd "$( dirname "$0" )" && pwd )

set -e

# run

COMPOSER_SHOW_INSTALLED="composer show --installed"
COMPOSER="composer install --prefer-dist"
NPM="npm install"

# If deploying, use production settings
if [ -n "$HAL_ENVIRONMENT" ]; then
    COMPOSER="composer install --prefer-dist --no-dev --no-interaction --ansi --optimize-autoloader --profile --no-progress"
    NPM="npm install --production --color=always"
fi

# download, update composer
if [ ! -f "$DIR/composer" ]; then
    echo "Downloading composer from http://composer..."
    curl http://composer/installer | bash -s "$DIR/composer"
    echo
fi

echo "$TITLE_COMPOSER"
"$DIR/"$COMPOSER
if [ -n "$HAL_ENVIRONMENT" ]; then
    "$DIR/"$COMPOSER_SHOW_INSTALLED
fi

echo "$TITLE_NPM"
$NPM
