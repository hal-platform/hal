#!/usr/bin/env php
<?php
/**
 * @copyright Â©2014 Quicken Loans Inc. All rights reserved. Trade Secret,
 *    Confidential and Proprietary. Any dissemination outside of Quicken Loans
 *    is strictly prohibited.
 */

namespace QL\Hal\Bin;

use Slim\Environment;
use Symfony\Component\Finder\Finder;

$root = __DIR__ . '/..';
if (!$container = @include $root . '/configuration/bootstrap.php') {
    echo "The application failed to start.\n";
    exit(1);
}

// start slim to prime twig extension and inject synthetic services
Environment::mock(['PATH_INFO' => '/derpderp']);
$slim = $container->get('slim');
$slim->call();

// find and attempt to load the templates
$twigCache = $container->get('twig.template.dir');
$output = 'No templates found';

$files = (new Finder)
    ->files()
    ->name('*.twig')
    ->in($twigCache);

if ($files) {
    // Always create twig cache if not found
    if (!file_exists($twigCache)) {
        mkdir($twigCache);
    }

    $output = "Templates:\n";
    $env = $container->get('twig.environment');

    foreach ($files as $file) {
        $output .= $file->getRelativePathname() . "\n";
        $template = $env->loadTemplate($file->getRelativePathname());
        $template->render([]);
    }
}

echo <<<OUTPUT

Compiling twig templates
Target: $twigCache
$output
OUTPUT;
