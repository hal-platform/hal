#
# Definition conventions:
# - If 1-2 arguments, enter on a single line. Otherwise break each argument into its own line.
# - "calls" are always each on a separate line except when defining templates (for readability)
#
# # Naming conventions
#
# - Global middleware:      "slim.global_middleware.*"
# - Page middleware:        "middleware.*"

# - UI Controllers:          "*.page"
# - API Controllers:         "*.api"
# - Redirecting Controllers: "*.handler"

# - Single-page middleware: "*.middleware"
# - Single-page template:   "*.twig"
#
# Example (Page: "Sign In")
#  - 'signin.page'
#  - 'signin.middleware'
#  - 'signin.twig'
#
# - 'middleware.signin' (shared middleware to check if user is signed in)

services:
    notFoundHandler:     { alias: 'panthor.handler.notFoundHandler' }
    notAllowedHandler:   { alias: 'panthor.handler.notAllowedHandler' }
    phpErrorHandler:     { alias: 'panthor.handler.phpErrorHandler' }
    errorHandler:        { alias: 'panthor.handler.errorHandler' }

    ####################################################################################################################
    # RUN TIME INJECTED (SYNTHETIC) SERVICES
    ####################################################################################################################

    # Set by login or token middleware
    currentUser:         { synthetic: true }

    hal.build:           { synthetic: true }
    hal.push:            { synthetic: true }

    hal.user:            { synthetic: true }
    hal.userType:        { synthetic: true }
    hal.userPermission:  { synthetic: true }

    hal.application:     { synthetic: true }
    hal.credential:      { synthetic: true }
    hal.deployment:      { synthetic: true }
    hal.encrypted:       { synthetic: true }
    hal.environment:     { synthetic: true }
    hal.server:          { synthetic: true }

    hal.view:            { synthetic: true }
    hal.pool:            { synthetic: true }

    ####################################################################################################################
    # SLIM
    ####################################################################################################################

    slim.router.loader:
        parent: 'router.loader'
        calls:
            # %routes% is auto loaded by parent
            - ['addRoutes', ['%routes.api%']]
            # - ['addRoutes', ['%routes.api.crud%']]
            # - ['addRoutes', ['%routes.admin%']]
            # - ['addRoutes', ['%routes.application%']]

    slim.global_middleware:
        class: 'QL\Panthor\Bootstrap\GlobalMiddlewareLoader'
        arguments: ['@service_container', '%global_middleware%']
    slim.global_middleware.logger:
        class: 'Hal\UI\Middleware\LoggerGlobalMiddleware'
        arguments: ['@mcp.logger.factory']
    slim.global_middleware.session:
        class: 'Hal\UI\Middleware\SessionGlobalMiddleware'
        arguments: ['@cookie.handler', '%session.lifetime%']
    slim.global_middleware.user_session:
        class: 'Hal\UI\Middleware\UserSessionGlobalMiddleware'
        arguments: ['@doctrine.em', '@uri']
    slim.global_middleware.flash:
        class: 'Hal\UI\Middleware\FlashGlobalMiddleware'
        arguments: ['@cookie.handler']
    slim.global_middleware.template_context:
        class: 'Hal\UI\Middleware\TemplateContextGlobalMiddleware'
        arguments: ['@twig.context']

    hal.pushfile.path:
        class: 'stdClass'
        factory: ['QL\Panthor\Utility\Stringify', 'template']
        arguments: ['%%s/%%s', ['@root', '.hal9000.push.yml']]

    ####################################################################################################################
    # ERROR & EXCEPTION HANDLING
    ####################################################################################################################

    logger:
        parent: 'mcp.logger'

    content_handler:
        class: 'QL\Panthor\ErrorHandling\ContentHandler\LoggingContentHandler'
        arguments:
            - '@panthor.content_handler'
            - '@logger'
            - { error: 'critical' }

    doctrine.utility.lazy.user:
        class: 'Hal\UI\Utility\LazyUserRetriever'
        arguments: ['@twig.context']

    ####################################################################################################################
    # CACHING
    ####################################################################################################################

    cache:
        class: 'QL\MCP\Cache\PredisCache'
        arguments: ['@redis']

    github.cache:
        class: 'QL\MCP\Cache\PredisCache'
        arguments: ['@redis']
        calls:
            - ['setMaximumTtl', ['%cache.github.default.ttl%']]

    ####################################################################################################################
    # HELPERS
    ####################################################################################################################

    utility.name.formatter:
        class: 'Hal\UI\Utility\NameFormatter'

    utility.id.generator:
        class: 'QL\Hal\Core\JobIdGenerator'
        arguments:
            - '%application.major.version%'
            - '%unique.alphabet%'
            - '%unique.size%'

    utility.time.formatter:
        class: 'Hal\UI\Utility\TimeFormatter'
        arguments: ['@clock', '%date.timezone%']

    guzzle:
        class: 'GuzzleHttp\Client'
