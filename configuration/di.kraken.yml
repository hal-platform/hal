# Application specific endpoints and controllers go here
# This includes handlers, middleware, or validators dedicated to a single page.
services:

    kraken.application:     { synthetic: true }
    kraken.environment:     { synthetic: true }
    kraken.property:        { synthetic: true }
    kraken.configuration:   { synthetic: true }
    kraken.target:          { synthetic: true }

    ####################################################################################################################
    # SERVICES
    ####################################################################################################################

    # override the default orm driver
    doctrine.config.driver:
        class: 'Doctrine\ORM\Mapping\Driver\SimplifiedYamlDriver'
        arguments: [@doctrine.mapping.dirs]
        calls:
            - ['setGlobalBasename', ['global']]

    doctrine.mapping.dirs:
        class: 'stdClass'
        factory: ['QL\Kraken\Utility\DiArrayUtil', 'associative']
        arguments:
            -
                key: @doctrine.mapping.dir
                value: 'QL\Hal\Core\Entity'
            -
                key: @doctrine.mapping.dir.kraken
                value: 'QL\Kraken\Entity'

    doctrine.mapping.dir.kraken:
        class: 'stdClass'
        factory: [@directory.helper, 'fullPath']
        arguments: ['configuration/kraken']

    ####################################################################################################################
    # CONTROLLERS
    ####################################################################################################################

    kraken.page:
        class: 'QL\Kraken\Controller\IndexController'
        arguments:
            - @slim.request
            - @kraken.twig
            - @doctrine.em
    kraken.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/index.twig']]]

    kraken.applications.page:
        class: 'QL\Kraken\Controller\ApplicationsController'
        arguments:
            - @slim.request
            - @kraken.applications.twig
            - @doctrine.em
            - @url
            - @session
    kraken.applications.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/applications.twig']]]

    kraken.environments.page:
        class: 'QL\Kraken\Controller\EnvironmentsController'
        arguments:
            - @slim.request
            - @kraken.environments.twig
            - @doctrine.em
            - @url
            - @session
    kraken.environments.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/environments.twig']]]

    kraken.application.page:
        class: 'QL\Kraken\Controller\ApplicationController'
        arguments:
            - @kraken.application.twig
            - @kraken.application
            - @doctrine.em
    kraken.application.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/application.twig']]]

    kraken.application.target.page:
        class: 'QL\Kraken\Controller\Application\TargetController'
        arguments:
            - @slim.request
            - @kraken.application.target.twig
            - @kraken.application
            - @kraken.environment
            - @doctrine.em
            - @url
            - @session
            - @slim.not.found
    kraken.application.target.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/application/target.twig']]]

    kraken.application.property.page:
        class: 'QL\Kraken\Controller\Schema\PropertyController'
        arguments:
            - @kraken.application.property.twig
            - @kraken.application
            - @kraken.property
            - @slim.not.found
    kraken.application.property.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/schema/property.twig']]]

    kraken.application.status.page:
        class: 'QL\Kraken\Controller\Application\StatusController'
        arguments:
            - @kraken.application.status.twig
            - @kraken.application
            - @doctrine.em
            - @slim.not.found
    kraken.application.status.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/application/status.twig']]]

    kraken.application.configuration.page:
        class: 'QL\Kraken\Controller\Configuration\ConfigurationController'
        arguments:
            - @kraken.application.configuration.twig
            - @kraken.application
            - @kraken.configuration
            - @doctrine.em
    kraken.application.configuration.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/configuration/configuration.twig']]]

    ####################################################################################################################
    # CRUD CONTROLLERS
    ####################################################################################################################

    kraken.application.add_target.page:
        class: 'QL\Kraken\Controller\Application\AddTargetController'
        arguments:
            - @slim.request
            - @kraken.application.add_target.twig
            - @kraken.application
            - @doctrine.em
            - @url
            - @session
    kraken.application.add_target.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/application/add-target.twig']]]

    kraken.application.add_schema.page:
        class: 'QL\Kraken\Controller\Schema\AddSchemaController'
        arguments:
            - @slim.request
            - @kraken.application.add_schema.twig
            - @kraken.application
            - @doctrine.em
            - @url
            - @session
    kraken.application.add_schema.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/schema/add-schema.twig']]]

    kraken.deploy.page:
        class: 'QL\Kraken\Controller\Configuration\DeployController'
        arguments:
            - @kraken.deploy.twig
            - @kraken.target
            - @doctrine.em
    kraken.deploy.twig:
        parent: 'kraken.template'
        calls: [['setTemplate', ['kraken/configuration/deploy.twig']]]

    kraken.deploy.handler:
        class: 'QL\Kraken\Controller\Configuration\DeployHandler'
        arguments:
            - @kraken.target
            - @kraken.json
            - @session.flashfire
            - @doctrine.em
            - @kraken.consul

    ####################################################################################################################
    # UTIL
    ####################################################################################################################

    kraken.template:
        parent: 'twig.template'
        class: 'QL\Kraken\Application\AutoRenderingTemplate'
        calls: [['setResponse', [@slim.response]]]

    kraken.twig.extension:
        class: 'QL\Kraken\Application\KrakenTwigExtension'

    kraken.json:
        class: 'QL\Panthor\Utility\Json'

    kraken.guzzle:
        class: 'GuzzleHttp\Client'

    kraken.consul:
        class: 'QL\Kraken\ConsulService'
        arguments: [@kraken.guzzle]

    ####################################################################################################################
    # MIDDLEWARE
    ####################################################################################################################

    kraken.middleware.require.entity:
        class: 'QL\Kraken\Middleware\RequireEntityMiddleware'
        arguments:
            - @service_container
            - @doctrine.em
            - @slim.not.found
            - @slim.route.parameters
