{% extends 'base.twig' %}
{% import 'macros.twig' as macros %}
{% import 'macros.pagination.twig' as pagination %}

{% set page_title = "Release History : " ~ application.name %}

{% block content %}

    {% set server = deployment.formatPretty %}

    <div class="nav--page">
        <h1>Release History - <b>{{ application.name }}</b> to <b>{{ server }}</b></h1>

        <p class="nav--page__back">
            <a class="btn btn--small btn--back" href="{{ uriFor('application.dashboard', {'application': application.id}) }}">Back to Application Dashboard</a>
        </p>
    </div>

    <h2>Deployment Details</h2>
    <div class="details-box">
        <ul class="mbn">
            <li>Environment</li>
            <li>
                <a href="{{ uriFor('environment', {'environment': deployment.server.environment.id}) }}">{{ deployment.server.environment.name }}</a>
            </li>

            <li>Server</li>
            <li>
                <a href="{{ uriFor('server', {'server': deployment.server.id}) }}">{{ server }}</a>
            </li>

            <li>
                Parameters
            </li>
            <li>
                {{ deployment.formatParameters }}
            </li>

            {% if deployment.url %}
                <li>URL</li>
                <li>
                    <a href="{{ deployment.url }}">{{ deployment.url }}</a>
                </li>
            {% endif %}
        </ul>
    </div>

    <p>
        This table shows the push history for this deployment.
        To rollback, simply choose a build, click <b>rollback</b>, and you'll be able to initate a new push.
    </p>

    {% set canRollback = canUserPush(current_user, application, deployment.server.environment) %}

    <h2>Release History</h2>
    <table class="table--spacing-medium">
        <thead>
            <tr>
                <th>Build</th>
                <th>Push</th>
                <th class="table-priority-45">Reference</th>
                <th class="table-priority-50">Commit</th>
                <th>Pushed</th>
                <th>User</th>
                {% if canRollback %}
                    <th class="t10"></th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for push in pushes %}
            <tr>
                <td><a href="{{ uriFor('build', {'build': push.build.id}) }}">{{ push.build.id|formatBuildId }}</a></td>
                <td>
                    {% set statusClass = 'status-icon--info' %}
                    {% if push.status == 'Success' %}
                        {% set statusClass = 'status-icon--success' %}
                    {% elseif push.status == 'Error' %}
                        {% set statusClass = 'status-icon--error' %}
                    {% endif %}
                    <span class="{{ statusClass }}">
                        Push <a href="{{ uriFor('push', {'push': push.id}) }}">{{ push.id|formatPushId }}</a>
                    </span>
                </td>

                <td class="table-priority-45">
                    {{ macros.gitref(push.build, true) }}
                </td>
                <td class="table-priority-50">
                    {{ macros.gitcommit(push.build) }}
                </td>
                <td>{{ push.end|html5date }}</td>
                <td>
                    {% if push.user %}
                        <a href="{{ uriFor('user', {'user': push.user.id}) }}">{{ push.user.handle }}</a>
                    {% else %}
                        Unknown
                    {% endif %}
                </td>

                {% if canRollback %}
                    <td class="tr">
                        {% if push.build.status == 'Removed' %}
                            Removed
                        {% elseif push.status == 'Success'%}
                            <a class="btn btn--tiny" href="{{ uriFor('push.start', {'build': push.build.id}, {'target': deployment.id}) }}">Rollback</a>
                        {% endif %}
                    </td>
                {% endif %}
            </tr>
            {% else %}
            <tr>
                <td colspan="{{ canRollback ? 6 : 5 }}">
                    There is no push history for this deployment.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {{ pagination.pagination(page, last, 'rollback', {'application': application.id, 'target': deployment.id}) }}

{% endblock %}
