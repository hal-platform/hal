{% extends 'base.html.twig' %}

{% set page_title = "Status: " ~ repo.name %}

{% import _self as page_macros %}

{% block content %}
    <h2>Repository Status for <strong>{{ repo.name }}</strong></h2>

    {# Only allow environment switching if has multiple env #}
    {% if environments|length > 1 %}
        <div class="trailer">
            <h4>Change environment</h4>
            {% for environment in environments %}
                {% set btnSelected = environment.id == selected_environment.id ? ' btn--action' : ' btn--not-selected' %}
                <a class="btn{{ btnSelected }}" href="{{ urlFor('repository.status', {id: repo.id}, {environment: environment.id}) }}">{{ environment.key }}</a>
            {% endfor %}
        </div>
    {% endif %}

    {% set hasPushes = false %}

    <h3 class="{{ (deployment_statuses) ? 'js-overloader-parent' : '' }}">
        Server Status for <strong>{{ selected_environment.key }}</strong>
    </h3>

    {# example display of servers by environment #}
    {% if deployment_statuses %}
        <ul class="list--bare cards cards--{{ selected_environment.key }}">
            {% for status in deployment_statuses %}

                {# Determine whether repo has been pushed so we can hide the all pushes button if there are no pushes #}
                {% if status.latest %}
                    {% set hasPushes = true %}
                {% endif %}

                {# Determine the active push #}
                {% set activePush = null %}
                {% if status.latest.status in ['Waiting', 'Pushing'] %}
                    {% set activePush = status.latest %}
                {% elseif status.success %}
                    {% set activePush = status.success %}
                {% endif %}

                <li>{{ page_macros.pushCard(repo, status.deploy, activePush, status.success) }}</li>
            {% endfor %}
        </ul>
    {% else %}
        <p>This repository has no deployment relationships for <strong>{{ selected_environment.key }}</strong> and cannot be pushed.</p>
    {% endif %}

    <h3>Recent Builds for <strong>{{ selected_environment.key }}</strong></h3>
    {% include 'partials/build-table.twig' with {'builds': builds} %}

    <p>
        {% if canUserBuild(currentUser, repo.key) %}
            <a class="btn--toggles btn--action" href="{{ urlFor('build.start', {'id': repo.id}) }}">Start New Build</a>
        {% endif %}

        {% if builds %}
            <a class="btn--toggles" href="{{ urlFor('build.history.page1', {'id': repo.id}) }}">View all Builds</a>
        {% endif %}

        {% if hasPushes %}
            <a class="btn--toggles" href="{{ urlFor('push.history.page1', {'id': repo.id}) }}">View all Pushes</a>
        {% endif %}

        <a href="{{ urlFor('repository', {id: repo.id}) }}">View Repository Information</a>
    </p>

{% endblock %}

{% macro pushCard(repo, deployment, active, hasHistory) %}
    {% import 'partials/macros.twig' as macros %}

    <article class="card">
        <header class="card__header">
            <h4 class="mbn">
                <a href="{{ urlFor('server', {'id': deployment.server.id}) }}">{{ deployment|formatDeploymentServer }}</a>

                {% if deployment.url %}
                    <a class="icon--link" href="{{ deployment.url.asString }}">
                        <svg class="icon"><use xlink:href="#outgoing"></use></svg>
                    </a>
                {% endif %}

                {% if hasHistory %}
                    <a class="rollback icon--link" href="{{ urlFor('rollback.page1', {'id': repo.id, 'deployment': deployment.id}) }}" title="View push history or rollback to a successful build">
                        <svg class="icon"><use xlink:href="#revert"></use></svg>
                    </a>
                {% endif %}
            </h4>
        </header>

        <section class="card__details">
            <ul class="split">
                {# push details #}
                <li>
                    <span class="split__title">Last push:</span>
                    {% if active %}
                        {% if active.status in ['Success', 'Error'] %}
                            <span class="status-before--{{ active.status == 'Success' ? 'success' : 'error' }}">
                                {{ active.status }}
                            </span>
                        {% else %}
                            <span class="status-before--other" data-push="{{ active.id }}">
                                {{ active.status }}
                            </span>
                        {% endif %}

                        (<a href="{{ urlFor('push', {'push': active.id}) }}">{{ active.id|formatPushId }}</a>)
                    {% else %}
                        None
                    {% endif %}
                </li>
                <li>
                    <span class="split__title">Pushed on:</span>
                    {% if active.created %}
                        {{ active.created|html5date }}
                    {% else %}
                        Never
                    {% endif %}
                </li>

                {# build details #}
                <li class="js-data-overload">
                    <span class="split__title">Build:</span>
                    {% if active %}
                        <a href="{{ urlFor('build', {'repo': repo.id, 'build': active.build.id}) }}">{{ active.build.id|formatBuildId }}</a>
                    {% else %}
                        Unknown
                    {% endif %}
                </li>
                <li class="js-data-overload">
                    <span class="split__title">Reference:</span>
                    {% if active %}
                        {% set isCurrent = githubCommitIsCurrent(repo.githubUser, repo.githubRepo, active.build.branch, active.build.commit) %}
                        <span class="status-before--{{ isCurrent ? 'success' : 'warning' }}">
                            {{ macros.gitref(active.build, true) }}
                        </span>

                    {% else %}
                        Unknown
                    {% endif %}
                </li>
                <li class="js-data-overload">
                    <span class="split__title">Commit:</span>
                    {% if active %}
                        {{ macros.gitcommit(active.build) }}
                    {% else %}
                        Unknown
                    {% endif %}
                </li>

                {# deployment details #}

                {% set deploymentDetails = deployment|formatDeploymentDetails %}

                <li class="js-data-overload">
                    <span class="split__title">{{ deployment|formatDeploymentDetailsLabel }}:</span>
                    <code title="{{ deploymentDetails }}">{{ deploymentDetails }}</code>
                </li>
            </ul>
        </section>
    </article>
{% endmacro %}
