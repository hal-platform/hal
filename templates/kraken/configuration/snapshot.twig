{% extends 'base.kraken.twig' %}
{% import "_partial/macros.twig" as macros %}

{% set page_title = is_deployed ? 'Deployed Snapshot' : 'Snapshot' %}
{% set isAdmin = true %}

{% block content %}

    <h1>{{ page_title }} for <strong>{{ configuration.environment.name }}</strong></h1>

    <h4>Application</h4>
    <p>{{ application.name }}</p>

    <h4>Environment</h4>
    <p>{{ configuration.environment.name }}</p>

    <h4>Configuration ID</h4>
    <p>{{ configuration.id }}</p>

    <ul class="button-list">
        <li><a class="btn" href="{{ urlFor('kraken.status', {application: application.id}) }}">Application Configuration</a></li>
        <li><a class="btn" href="{{ urlFor('kraken.configuration.compare', {configuration: configuration.id}) }}">Compare to latest configuration</a></li>
        <li><a class="btn btn--secondary" href="{{ urlFor('kraken.configuration.history.page1', {application: application.id}) }}">Configuration History</a></li>
    </ul>

    {% include 'kraken/_partial/configuration.status.twig' %}

    {% if isAdmin %}
        {% set deploy_title = is_deployed or not configuration.isSuccess ? 'Redeploy' : 'Rollback' %}

        <h3>{{ deploy_title }}</h3>
        <p class="trailer--andre"><a class="btn btn--action" href="{{ urlFor('kraken.rollback', {configuration: configuration.id}) }}">{{ deploy_title }} this Snapshot</a></p>
    {% endif %}

    <h2>Configuration</h2>
    {% include 'kraken/_partial/configuration.twig' with {'properties': properties} %}

    <h2>Deployment Audit Log</h2>
    {{ block('audit_log') }}

{% endblock %}

{% block audit_log %}
    {% if audits %}
        <table class="table--spacing-medium table--striped table--top-aligned" data-tablesaw-mode="stack">
            <thead>
                <tr>
                    <th>Property</th>
                    <th class="t15">Type</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for log in audits %}
                    <tr>
                        <td><code class="code_clear">{{ log.key }}</code></td>
                        <td>
                            {{ log.type == 'update' ? 'Update' : 'Removal' }}
                        </td>
                        <td>
                            {% if log.isSuccess %}
                                <span class="tooltipped tooltipped-n" aria-label="The property was updated successfully">
                                    {{ macros.status_icon('Success', 'success') }}
                                </span>

                            {% elseif log.detail is same as(false) %}
                                <span class="tooltipped tooltipped-n" aria-label="The property was not updated. The system failed to obtain a lock.">
                                    {{ macros.status_icon('Consul Error', 'error') }}
                                </span>

                            {% elseif log.detail is same as(null) %}
                                <span class="tooltipped tooltipped-n" aria-label="The property was not updated. An unexpected error occured.">
                                    {{ macros.status_icon('Unknown Error', 'error') }}
                                </span>
                            {% else %}
                                <span class="tooltipped tooltipped-n" aria-label="The property was not updated. A service error occured.">
                                    {{ macros.status_icon('Error: ' ~ log.detail, 'error') }}
                                </span>
                            {% endif %}
                        </td>

                    </tr>
                {% endfor %}
            <tbody>
        </table>
    {% else %}
        <p>There is no deployment log.</p>
    {% endif %}
{% endblock %}
