{% extends 'base.html.twig' %}
{% import "_partial/macros.twig" as macros %}
{% import _self as page_macros %}
{% set js_components = ["build.start"] %}

{% set page_title = "Start Build : " ~ application.name %}

{% block content %}

    <h1>Start Build - <strong>{{ application.name }}</strong></h1>

    <p><a class="btn btn--small btn--back" href="{{ urlFor('application.status', {'application': application.id}) }}">Back to Application Status</a></p>

    {% if errors %}
        <ul class="error-list js-backend-error">
            {% for error in errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <form method="post" name="start-build">

        {% block select_environment %}
            <h3>Select Environment:</h3>

            {% if environments %}
                <ul class="radio-grid radio-grid--tri">
                    {% for env in environments %}
                        <li>
                            <input id="env-{{ env.id }}" type="radio" name="environment" value="{{ env.id }}"{{ form.environment == env.id ? ' checked' : ''}}>
                            <label for="env-{{ env.id }}">{{ env.name }}</label>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                {% set alert_message = 'There are no buildable environments for this application. Deployments must added.' %}
                {{ macros.alert('error', alert_message) }}
            {% endif %}
        {% endblock %}

        {% block select_build %}
            <h3>Select Source:</h3>

            <ul class="form-fields">
                <li class="mbn">
                    <label for="js-search-input">Search for a Branch, Tag, Pull Request, or enter a Commit ID.</label>
                    <input id="js-search-input" class="text-input" type="text" name="search" autocomplete="off" value="{{ form.search }}" maxlength="200">
                </li>
            </ul>

            <div class="js-search-drop">
                <ul class="list--bare js-search-results">
                    <!-- search results go here -->
                    {% for branch in branches %}
                        {{ page_macros.search('branch', branch) }}
                    {% endfor %}
                    {% for tag in tags %}
                        {{ page_macros.search('release', tag) }}
                    {% endfor %}
                    {% for pull in open %}
                        {{ page_macros.search('pull-request', pull) }}
                    {% endfor %}
                    {% for pull in closed %}
                        {{ page_macros.search('pull-request-closed', pull) }}
                    {% endfor %}
                </ul>
            </div>

            {# Dynamic warning, for when HAL cannot find a matching radio option #}
            {% set warningLabel = isSeriousBusinessMode() ? 'Start Build?' : 'Start Build. Maybe?' %}
            <div class="leader js-build-warning" data-label="Start Build" data-label-warning="{{ warningLabel }}">

                {% if isSeriousBusinessMode() %}
                    {% set alert_message = 'A git reference cannot be found from your search query. HAL will attempt to resolve this reference on the backend.' %}
                    {% set alert_details = '' %}
                {% else %}
                    {% set alert_message = "Just what do you think you're doing, Dave?" %}
                    {% set alert_details = 'I cannot find a git reference for your search query.<br>However if you attempt to build using this query, I will use my enormous intellect to fulfill the mission.' %}
                {% endif %}

                {{ macros.alert('warning', alert_message, alert_details) }}
            </div>

            {% if environments %}
                <div class="leader"><input class="btn" type="submit" value="Start Build" name="submit"></div>
            {% endif %}

            {{ block('build_tabs') }}

            <div class="tab-content js-tab-content">

                {{ block('build_tabs_branches') }}
                {{ block('build_tabs_releases') }}
                {{ block('build_tabs_open') }}
                {{ block('build_tabs_closed') }}

            </div>

            {% if environments %}
                <input class="btn" type="submit" value="Start Build" name="submit">
            {% endif %}
        {% endblock %}

    </form>

{% endblock %}

{% block build_tabs %}

    <ul class="list--bare tabs js-tabs">
        <li class="active">
            <a name="js-tab--branches">
                {{ macros.icon('branch') }}
                <span class="tab-text">Branches</span>
            </a>
        </li>
        <li>
            <a name="js-tab--tags">
                {{ macros.icon('tag') }}
                <span class="tab-text">Releases</span>
            </a>
        </li>
        <li>
            <a name="js-tab--pr-open">
                {{ macros.icon('pull', 'github__pr--open') }}
                <span class="tab-text">Open Pull Requests</span>
            </a>
        </li>
        <li>
            <a name="js-tab--pr-closed">
                {{ macros.icon('pull', 'github__pr--closed') }}
                <span class="tab-text">Closed Pull Requests</span>
            </a>
        </li>
    </ul>

{% endblock %}

{% block build_tabs_branches %}
    <div id="js-tab--branches" class="tab js-tab-active">
        <ul class="js-search-list radio-grid radio-grid--tri">
            {% for branch in branches %}
                <li>
                    {% set uniqueId = hash(branch.object.sha ~ '-' ~ branch.name) %}

                    <input
                        id="{{ uniqueId }}"
                        type="radio"
                        name="reference"
                        value="{{ branch.name }}"
                    >

                    <label for="{{ uniqueId }}" title="{{ branch.name }}">
                        {{ macros.icon('branch') }}
                        {{ branch.name }} <br />

                        <a href="{{ githubBranchUrl(application.githubOwner, application.githubRepo, branch.name) }}">{{ branch.object.sha|commit }}</a>
                        {{ macros.icon('github') }}
                    </label>
                </li>

            {% else %}
                <li class="full">There are no branches.</li>
            {% endfor %}
        </ul>
    </div>

{% endblock %}

{% block build_tabs_releases %}
    <div id="js-tab--tags" class="tab">
        <ul class="js-search-list radio-grid radio-grid--tri">
            {% for tag in tags %}
                <li>
                    {% set uniqueId = hash(tag.object.sha ~ '-' ~ tag.name) %}

                    <input
                        id="{{ uniqueId }}"
                        type="radio"
                        name="reference"
                        value="tag/{{ tag.name }}"
                    >

                    <label for="{{ uniqueId }}">
                        {{ macros.icon('tag') }}
                        {{ tag.name }} <br />

                        <a href="{{ githubReleaseUrl(application.githubOwner, application.githubRepo, tag.name) }}">{{ tag.object.sha|commit }}</a>
                        {{ macros.icon('github') }}
                    </label>
                </li>

            {% else %}
                <li class="full">There are no tags.</li>
            {% endfor %}
        </ul>
    </div>
{% endblock %}

{% block build_tabs_open %}
    <div id="js-tab--pr-open" class="tab">
        <ul class="js-search-list radio-grid radio-grid--tri">
            {% for pull in open %}
                <li>
                    {% set uniqueId = hash('pr' ~ pull.number) %}

                    <input
                        id="{{ uniqueId }}"
                        type="radio"
                        name="reference"
                        value="pull/{{ pull.number }}"
                    >

                    <label for="{{ uniqueId }}" title="{{ pull.title }}">
                        {{ macros.icon('pull', 'github__pr--open') }}
                        <span class="js-title">{{ pull.title }}</span>
                        <br />

                        <a href="{{ githubPullRequestUrl(application.githubOwner, application.githubRepo, pull.number) }}">PR #{{ pull.number }}</a>
                        {{ macros.icon('github') }}
                        <br />

                        {% set label_style = "github__pr" %}
                        {% if pull.head.user.login|lower == currentUser.handle|lower %}
                            {% set label_style = label_style ~ " github__pr--owner" %}
                        {% endif %}

                        <span class="{{ label_style }}">
                            from <span class="github__pr--label" title="{{ pull.head.user.login }}:{{ pull.head.ref }}">
                                <span class="github__pr--source">{{ pull.head.user.login }}:</span>{{ pull.head.ref }}
                            </span>
                            <br>

                            to <span class="github__pr--label" title="{{ pull.base.user.login }}:{{ pull.base.ref }}">{{ pull.base.ref }}</span>
                        </span>
                    </label>
                </li>

            {% else %}
                <li class="full">There are no open pull requests.</li>
            {% endfor %}
        </ul>
    </div>
{% endblock %}

{% block build_tabs_closed %}
    <div id="js-tab--pr-closed" class="tab">
        <ul class="js-search-list radio-grid radio-grid--tri">
            {% for pull in closed %}
                <li>
                    {% set uniqueId = hash('pr' ~ pull.number) %}

                    <input
                        id="{{ uniqueId }}"
                        type="radio"
                        name="reference"
                        value="pull/{{ pull.number }}"
                    >

                    <label for="{{ uniqueId }}" title="{{ pull.title }}">
                        {{ macros.icon('pull', 'github__pr--closed') }}
                        <span class="js-title">{{ pull.title }}</span>
                        <br />

                        <a href="{{ githubPullRequestUrl(application.githubOwner, application.githubRepo, pull.number) }}">PR #{{ pull.number }}</a>
                        {{ macros.icon('github') }}
                        <br />

                        {% set label_style = "github__pr" %}
                        {% if pull.head.user.login|lower == currentUser.handle|lower %}
                            {% set label_style = label_style ~ " github__pr--owner" %}
                        {% endif %}

                        <span class="{{ label_style }}">
                            from <span class="github__pr--label" title="{{ pull.head.user.login }}:{{ pull.head.ref }}">
                                <span class="github__pr--source">{{ pull.head.user.login }}:</span>{{ pull.head.ref }}
                            </span>
                            <br>

                            to <span class="github__pr--label" title="{{ pull.base.user.login }}:{{ pull.base.ref }}">{{ pull.base.ref }}</span>
                        </span>
                    </label>
                </li>

            {% else %}
                <li class="full">There are no closed pull requests.</li>
            {% endfor %}
        </ul>
    </div>
{% endblock %}

{% macro search(type, ref) %}
    {% import "_partial/macros.twig" as macros %}

    {# This is a search listing generated for the javascript #}

    {% if type == 'pull-request' %}
        {% set uniqueId = hash('pr' ~ ref.number) %}

        <li class="js-search-item" data-parent="{{ uniqueId }}" data-tab="js-tab--pr-open">
            {{ macros.icon('pull', 'github__pr--open') }}
            <span class="js-search-primary">PR #{{ ref.number }} : {{ ref.title }}</span>

            <span class="js-search-query">PR #{{ ref.number }}</span>
            <span class="js-search-query">pull request {{ ref.number }}</span>
            <span class="js-search-query">{{ ref.title }}</span>
        </li>

    {% elseif type == 'pull-request-closed' %}
        {% set uniqueId = hash('pr' ~ ref.number) %}

        <li class="js-search-item" data-parent="{{ uniqueId }}" data-tab="js-tab--pr-closed">
            {{ macros.icon('pull', 'github__pr--closed') }}
            <span class="js-search-primary">PR #{{ ref.number }} : {{ ref.title }}</span>

            <span class="js-search-query">PR #{{ ref.number }}</span>
            <span class="js-search-query">pull request {{ ref.number }}</span>
            <span class="js-search-query">{{ ref.title }}</span>
        </li>
    {% elseif type == 'release' %}
        {% set uniqueId = hash(ref.object.sha ~ '-' ~ ref.name) %}

        <li class="js-search-item" data-parent="{{ uniqueId }}" data-tab="js-tab--tags">
            {{ macros.icon('tag') }}
            <span class="js-search-primary">{{ ref.name }}</span>
        </li>
    {% elseif type == 'branch' %}
        {% set uniqueId = hash(ref.object.sha ~ '-' ~ ref.name) %}

        <li class="js-search-item" data-parent="{{ uniqueId }}" data-tab="js-tab--branches">
            {{ macros.icon('branch') }}
            <span class="js-search-primary">{{ ref.name }}</span>
        </li>
    {% endif %}

{% endmacro %}
