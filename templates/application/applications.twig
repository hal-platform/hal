{% extends 'base.twig' %}
{% import _self as page_macros %}
{% import "macros.twig" as macros %}
{% set js_components = ["applications.list"] %}

{% set page_title = "Applications" %}

{% block content %}
    <h1>{{ page_title }}</h1>

    {% if favorites %}
        <h2>Favorites</h2>
        <table class="table--spacing-medium">
            <thead>
                <tr>
                    <th>Application</th>
                    <th class="t50">GitHub Source</th>
                    <th class="t5"></th>
                </tr>
            </thead>
            <tbody>
                {% for application in favorites %}
                    {{ page_macros.app_row(current_user, application) }}
                {% endfor %}
            </tbody>
        </table>

    {% endif %}

    <h2>Organizations</h2>

    <ul>
        {% for group_id, group_applications in applications %}
            {% set group = groups[group_id] %}
            {% if group_applications %}
                <li><a href="#org-{{ group_id }}">{{ group.name }}</a></li>
            {% endif %}
        {% endfor %}
    </ul>

    <h2>Applications</h2>

<input id="js-search-input" class="text-input" type="text" name="search" autocomplete="off" placeholder="Search for an application or repository..." maxlength="100">

    <table class="table--spacing-medium js-collapsible js-search-table">
        <thead>
            <tr>
                <th>Application</th>
                <th class="t50">GitHub Source</th>
                <th class="t10 tr js-collapsible-global"></th>
            </tr>
        </thead>

        {% set hasApplications = false %}

        {% for group_id, group_applications in applications %}
            <tbody class="js-search-group">
                {% set group = groups[group_id] %}
                <tr>
                    <th colspan="4" class="table-mid-header" id="org-{{ group_id}}">
                        <a href="{{ uriFor('organization', {'organization': group.id}) }}">{{ group.name }}</a>
                    </th>
                </tr>

                {% if group_applications %}
                    {% set hasApplications = true %}
                    {% for application in group_applications %}
                        {{ page_macros.app_row(current_user, application, true) }}
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4">No applications found.</td>
                    </tr>
                {% endif %}
            </tbody>
        {% endfor %}

        {% if not hasApplications %}
            <tr>
                <td colspan="4">There are no groups.</td>
            </tr>
        {% endif %}
    </table>

    <ul>
        <li><a class="btn" href="{{ uriFor('application.add') }}">Add Application</a></li>
        <li><a class="btn" href="{{ uriFor('organization.add') }}">Add Organization</a></li>
    </ul>
{% endblock %}

{% macro app_row(currentUser, application, allow_collapse) %}
    {% import "macros.twig" as macros %}

    {% if allow_collapse %}
        <tr class="js-collapsible-row js-search-item">
    {% else %}
        <tr>
    {% endif %}
        <td>
            {% if currentUser.settings.isFavoriteApplication(application) %}
                <form method="post"
                      action="{{ uriFor('settings.favorite_applications.remove', {'application': application.id}) }}"
                      data-app-id="{{ application.id }}"
                      class="form--fav">
                    <label class="form--fav__label fav-added">
                        <input type="submit">
                        {{ macros.icon('star-2', '', 'Remove from favorites') }}
                    </label>
                </form>
            {% else %}
                <form method="post"
                      action="{{ uriFor('settings.favorite_applications.add', {'application': application.id}) }}"
                      data-app-id="{{ application.id }}"
                      class="form--fav">
                    <label class="form--fav__label fav-normal">
                        <input type="submit">
                        {{ macros.icon('star-2', '', 'Add to favorites') }}
                    </label>
                </form>
            {% endif %}
            <a href="{{ uriFor('application.dashboard', {'application': application.id}) }}">{{ application.name }}</a>
        </td>
        <td>
            {{ macros.gitsource(application) }}
            <span class="js-search-query">{{ application.name }}</span>
            <span class="js-search-query">{{ application.githubOwner ~ '/' ~ application.githubRepo }}</span>
        </td>
        <td class="tr">
            <a href="{{ uriFor('application', {'application': application.id}) }}">Manage</a>
        </td>
    </tr>

{% endmacro %}

