{% extends 'base.twig' %}
{% import "macros.twig" as macros %}

{% set page_title = 'Application : ' ~ application.name %}

{% set isAdmin = isUserAdminOrSuper(current_user) %}
{% set canEdit = isUserAdminOrSuper(current_user) or isUserLeadOf(current_user, application) %}
{% set canRemove = isAdmin and not has_jobs %}

{% block content %}
    <div class="nav--page">
        <h1>Application - <b>{{ application.name }}</b></h1>

        <p class="nav--page__back">
            <a class="btn btn--small btn--back" href="{{ uriFor('application.dashboard', {'application': application.id}) }}">Go to Application Dashboard</a>
        </p>
    </div>

    {{ block('meta') }}

    <ul class="button-list">
        <li><a class="btn btn--secondary" href="{{ uriFor('encrypted.configuration', {'application': application.id}) }}">Encrypted Configuration</a></li>
        <li><a class="btn btn--secondary" href="{{ uriFor('targets', {'application': application.id}) }}">Deployment Targets</a></li>
    </ul>

    {% if canEdit or canRemove %}
        <ul class="leader button-list button-list--half">
            {% if canEdit %}
                <li><a class="btn btn--action" href="{{ uriFor('application.edit', {'application': application.id}) }}">Edit Application</a></li>
            {% endif %}

            {% if canRemove %}
                <li class="button-list__fixed"><a class="btn btn--destructive" href="{{ uriFor('application.remove', {'application': application.id}) }}">Remove Application</a></li>
            {% endif %}
        </ul>
    {% endif %}

    {{ block('deployment_access') }}

{% endblock %}

{% block meta %}
    <div class="details-box">
        <dl class="split">
            <dt class="split__title">Identifier</dt>
            <dd>{{ application.key }}</dd>

            <dt class="split__title">Name</dt>
            <dd>{{ application.name }}</dd>

            <dt class="split__title">GitHub Source</dt>
            <dd>{{ macros.gitsource(application) }}</dd>
        </dl>
    </div>
{% endblock %}

{% block deployment_access %}
    <h2>Deployment Access</h2>
    <div class="details-box">
        <p>Owners can manage this application, deploy to non-production environments, and grant others deployment access.</p>

        {% if permissions %}
            <div class="fav-box-wrapper">
                {% for perm in permissions %}

                    {% set alt = '' %}
                    {% if perm.permission == 'prod' %}{% set alt = ' fav-box-alt' %}{% endif %}
                    {% if perm.permission == 'lead' %}{% set alt = ' fav-box-alt-2' %}{% endif %}

                    <div class="fav-box{{ alt }}">
                        <h5>
                            <a href="{{ uriFor('user', {'user': perm.id }) }}">{{ perm.username|lower }}</a>
                        </h5>
                        <p>
                            {% if perm.permission == 'lead' %}Owner, {% endif %}{{ perm.permission == 'prod' ? 'Production' : 'Non-prod' }}
                        </p>
                    </div>
                {% endfor %}

            </div>
        {% else %}
            <hr>
            No users currently have deployment or management permissions. Deployment permissions are only handled by GitHub.
            Contact an administratorif you would like to self-service and manage your application.
        {% endif %}

        <hr>
        <p>
            Administrators can also manage and deploy this application.
        </p>

        {% if canEdit %}
            <a class="btn" href="#">Grant permissions TODO</a>
        {% endif %}

    </div>
{% endblock %}
