{% extends 'base.html.twig' %}

{% set page_title = repository.key %}

{% block content %}
    <h2 class="mbn"><b>{{ repository.key }}</b> repository details</h2>

    <div class="details-box">
        <dl class="split--left">
            <dt class="split--left__title">
                Description
            </dt>
            <dd class="split--left__value">
                {{ repository.description }}
            </dd>
            <dt class="split--left__title">
                Github Source
            </dt>
            <dd class="split--left__value">
                <a href="{{ githubRepo(repository.githubUser, repository.githubRepo) }}">{{ repository.githubUser }}/{{ repository.githubRepo }}</a>
                <span class="icon">
                    <svg viewBox="0 0 32 32">
                        <use xlink:href="#github"></use>
                    </svg>
                </span>
            </dd>
            <dt class="split--left__title">
                Notification E-mail
            </dt>
            <dd class="split--left__value">
                {{ repository.email }}
            </dd>
            <dt class="split--left__title">
                Build Command
            </dt>
            <dd class="split--left__value">
                {{ repository.buildCmd ?: 'No command entered.' }}
            </dd>
            <dt class="split--left__title">
                Pre-Push Command
            </dt>
            <dd class="split--left__value">
                {{ repository.prePushCmd ?: 'No command entered.' }}
            </dd>
            <dt class="split--left__title">
                Post-Push Command
            </dt>
            <dd class="split--left__value">
                {{ repository.postPushCmd ?: 'No command entered.' }}
            </dd>
        </dl>

        {# primary action #}
        {% if isAdmin %}
        <a class="btn" href="{{ urlFor('repository.status', {id: repository.id}) }}">View repository status</a>
        {% endif %}

        {# secondary actions #}
        <a class="btn--action secondary-action" href="{{ urlFor('repository.admin.edit', {id: repository.id}) }}">Edit details</a>

        {% if isAdmin and not deployments and canUserDelete(currentUser) %}
            <form class="secondary-action" action="{{ urlFor('repository.admin.remove.handle', {id: repository.id}) }}" method="post">
                <input class="btn--destructive" type="submit" value="Remove repository">
            </form>
        {% endif %}
    </div>

    <h3>Permissions</h3>

    <p>The following users have permission to push <strong>{{ repository.key }}</strong> to the specified environment.</p>

    <table class="t75">
        <thead>
        <tr>
            <th>Environment</th>
            <th colspan="3">Users</th>
        </tr>
        </thead>
        <tbody>
        {% for pairs in permissions %}
            <tr>
                <td>{{ pairs|first.environment.key|title }}</td>
                {% for chunk in pairs|chunk(3) %}
                <td>
                    <ul>
                        {% for pair in chunk %}
                            <li><a href="{{ urlFor('user', {'id': pair.user.id}) }}">{{ pair.user.name }}</a></li>
                        {% endfor %}
                    </ul>
                </td>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>Permissions</h3>
    <ul>
        {% for pair in permissions %}
            <li><a href="{{ urlFor('user', {'id': pair.user.id}) }}">{{ pair.user.name }}</a> has permission to build and push to <b>{{ pair.environment.key }}</b>.</li>
        {% else %}
            <li>No permissions found for this repository.</li>
        {% endfor %}
    </ul>

    <h3>Server deployments:</h3>
    {% if deployments %}
        <table class="t75">
            <thead>
                <tr>
                    <th>Hostname</th>
                    <th>Environment</th>
                    <th>Path</th>
                </tr>
            </thead>
            <tbody>
            {% for deployment in deployments %}
                <tr class="env-row-{{ deployment.server.environment.key }}">
                    <td>{{ deployment.server.name }}</td>
                    <td>{{ deployment.server.environment.key }}</td>
                    <td>{{ deployment.path }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>There are no deployments associated with this repository.</p>
    {% endif %}

    {% if isAdmin %}
        <a class="btn" href="{{ urlFor('repository.deployments', {id: repository.id}) }}">Manage deployments</a>
    {% endif %}

{% endblock %}
