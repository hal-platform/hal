{% extends 'base.html.twig' %}

{% set page_title = repository.key %}

{% block content %}
    <h2 class="mbn"><b>{{ repository.key }}</b> repository details</h2>

    <div class="details-box">
        <dl class="split--left">
            <dt class="split--left__title">
                Description
            </dt>
            <dd class="split--left__value">
                {{ repository.description }}
            </dd>
            <dt class="split--left__title">
                Github Source
            </dt>
            <dd class="split--left__value">
                <a href="{{ githubRepo(repository.githubUser, repository.githubRepo) }}">{{ repository.githubUser }}/{{ repository.githubRepo }}</a>
                <svg class="icon" viewBox="0 0 32 32"><use xlink:href="#github"></use></svg>
            </dd>
            <dt class="split--left__title">
                Notification E-mail
            </dt>
            <dd class="split--left__value">
                {{ repository.email }}
            </dd>
            <dt class="split--left__title">
                Build Command
            </dt>
            <dd class="split--left__value">
                {{ repository.buildCmd ?: 'No command entered.' }}
            </dd>
            <dt class="split--left__title">
                Pre-Push Command
            </dt>
            <dd class="split--left__value">
                {{ repository.prePushCmd ?: 'No command entered.' }}
            </dd>
            <dt class="split--left__title">
                Post-Push Command
            </dt>
            <dd class="split--left__value">
                {{ repository.postPushCmd ?: 'No command entered.' }}
            </dd>
        </dl>

        {# primary action #}
        <a class="btn" href="{{ urlFor('repository.status', {id: repository.id}) }}">View repository status</a>

        {# secondary actions #}
        {% if isUserAdmin(currentUser) %}
            <a class="btn--action secondary-action" href="{{ urlFor('repository.admin.edit', {id: repository.id}) }}">Edit details</a>
        {% endif %}

        {% if isUserAdmin(currentUser) and not deployments and canUserDelete(currentUser) %}
            <a class="btn--destructive secondary-action" href="{{ urlFor('repository.admin.remove.handle', {id: repository.id}) }}">Remove Repository</a>
        {% endif %}
    </div>

    <h3>Permissions</h3>

    <p>The following users have permission to push <strong>{{ repository.key }}</strong> to the specified environment.</p>

    <table class="tablesaw tablesaw-stack" data-mode="stack">
        <thead>
        <tr>
            <th>Environment</th>
            <th>Users</th>
        </tr>
        </thead>
        <tbody>
        {% for pairs in permissions %}
            <tr>
                <td>{{ pairs|first.environment.key|title }}</td>
                <td>
                    <ul class="col-list">
                        {% for pair in pairs %}
                            <li><a href="{{ urlFor('user', {'id': pair.user.id}) }}">{{ pair.user.name }}</a></li>
                        {% endfor %}
                    </ul>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>Server Deployments:</h3>
    {% if deployment_count %}
        <table class="tablesaw tablesaw-stack" data-mode="stack">
            <thead>
                <tr>
                    <th>Environment</th>
                    <th>Deployments</th>
                </tr>
            </thead>
            <tbody>
            {% for env, deployments in deployment_environments %}
                {% if deployments %}
                    <tr>
                        <td>{{ env }}</td>
                        <td>
                            <ul class="list--bare">
                                {% for deployment in deployments %}
                                    <li>
                                        <span class="fixed-size-label">
                                            <a href="{{ urlFor('server', {id: deployment.server.id}) }}">{{ deployment.server.name }}</a>
                                        </span>
                                        <code>{{ deployment.path }}</code>
                                    </li>
                                {% endfor %}
                            </ul>
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>There are no deployments associated with this repository.</p>
    {% endif %}

    {% if isUserAdmin(currentUser) %}
        <a class="btn" href="{{ urlFor('repository.deployments', {id: repository.id}) }}">Manage Deployment Relationships</a>
    {% endif %}

{% endblock %}
