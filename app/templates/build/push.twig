{% extends 'base.html.twig' %}

{% set page_title = "Push Build "~build.id %}

{% block content %}

    <h2>Push Build</h2>

    <p>Please review the below build details before pushing.</p>

    <div class="details-box">
        <dl class="split--left mbn">
            <dt class="split--left__title">
                Build ID
            </dt>
            <dd class="split--left__value">
                <a href="{{ urlFor('build', {build: build.id}) }}">{{ build.id }}</a>
            </dd>
            <dt class="split--left__title">
                Repository
            </dt>
            <dd class="split--left__value">
                <a href="{{ urlFor('repository', {id: build.repository.id}) }}">{{ build.repository.key }}</a>
            </dd>
            <dt class="split--left__title">
                Environment
            </dt>
            <dd class="split--left__value">
                {{ build.environment.key }}
            </dd>
            <dt class="split--left__title">
                Reference
            </dt>
            <dd class="split--left__value">
                {% if githubCommitIsCurrent(build.repository.githubUser, build.repository.githubRepo, build.branch, build.commit) %}
                    <span class="status-before--success">
                        <a href="{{ githubReference(build.repository.githubUser, build.repository.githubRepo, build.branch) }}">{{ build.branch|gitref }}</a>
                    </span>
                {% else %}
                    <span class="status-before--other">
                        <a href="{{ githubReference(build.repository.githubUser, build.repository.githubRepo, build.branch) }}">{{ build.branch|gitref }}</a>
                    </span>
                {% endif %}
                <svg viewBox="0 0 32 32" class="icon">
                    <use xlink:href="#fork"></use>
                </svg>
            </dd>
            <dt class="split--left__title">
                Commit
            </dt>
            <dd class="split--left__value">
                <a href="{{ githubCommit(build.repository.githubUser, build.repository.githubRepo, build.commit) }}">{{ build.commit|commit }}</a>
                <span class="icon">
                  <svg viewBox="0 0 32 32">
                      <use xlink:href="#github"></use>
                  </svg>
                </span>
            </dd>
            <dt class="split--left__title">
                Prepared By
            </dt>
            <dd class="split--left__value">
                {% if build.user %}
                    <a href="{{ urlFor('user', {'id': build.user.id}) }}">{{ build.user.name }}</a>
                {% elseif build.consumer %}
                    {{ build.consumer.name[:20] }}
                {% else %}
                    Unknown
                {% endif %}
            </dd>
            <dt class="split--left__title">
                Completed
            </dt>
            <dd class="split--left__value">
                {{ build.end|reldate }}
            </dd>

        </dl>
    </div>

    <p>
        This build can be pushed to the following servers. Please review the current status of each server below
        before selecting which servers you wish to deploy to.
    </p>

    <form action="{{ urlFor('push.handle', {'repo': build.repository.key, 'build': build.id}) }}" method="post">
    <div class="overflow-container">
        <table class="tablesaw tablesaw-stack" data-mode="stack">
            <thead>
            <tr>
                <th>Server</th>
                <th>Reference</th>
                <th>Commit</th>
                <th>Pushed</th>
                <th>Pushed By</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% set allowSubmit = false %}
            {% for status in statuses %}
                <tr>
                    <td><a href="{{ urlFor('server', {'id': status.deployment.server.id}) }}">{{ status.deployment.server.name }}</a> ({{ status.deployment.server.environment.key }})</td>
                    {% if status.success %}
                        <td>
                            <span {% if githubCommitIsCurrent(build.repository.githubUser, build.repository.githubRepo, status.success.build.branch, status.success.build.commit) %}
                                class="status-before--success"
                            {% else %}
                                class="status-before--other"
                            {% endif %}>
                                <a href="{{ githubReference(status.success.build.repository.githubUser, status.success.build.repository.githubRepo, status.success.build.branch) }}">{{ status.success.build.branch|gitref }}</a>
                                <svg viewBox="0 0 32 32" class="icon">
                                    <use xlink:href="#fork"></use>
                                </svg>
                            </span>
                        </td>
                        <td>
                            <a href="{{ githubCommit(build.repository.githubUser, build.repository.githubRepo, status.success.build.commit) }}">{{ status.success.build.commit|commit }}</a>
                            <span class="icon">
                                <svg viewBox="0 0 32 32">
                                    <use xlink:href="#github"></use>
                                </svg>
                            </span>
                        </td>
                        <td>{{ status.success.end|reldate }} (Push <a href="{{ urlFor('push', {'push': status.success.id}) }}">{{ status.success.id }}</a>)</td>
                        <td>
                            {% if status.success.user %}
                                <a href="{{ urlFor('user', {'id': status.success.user.id}) }}">{{ status.success.user.name }}</a>
                            {% elseif status.success.consumer %}
                                {{ status.success.consumer.name[:20] }}
                            {% else %}
                                Unknown
                            {% endif %}
                        </td>
                    {% else %}
                        <td colspan="4"></td>
                    {% endif %}
                    <td>
                        {% if canUserPush(user, status.deployment.repository.key, status.deployment.server.environment.key) %}
                            {% if status.deployment.id in selected %}
                                <label>Push Now <input type="checkbox" name="deployments[]" id="sel-{{ status.deployment.id }}" value="{{ status.deployment.id }}" checked></label>
                            {% else %}
                                <label>Push Now <input type="checkbox" name="deployments[]" id="sel-{{ status.deployment.id }}" value="{{ status.deployment.id }}"></label>
                            {% endif %}
                            {% set allowSubmit = true %}
                        {% else %}
                            No Access
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% if allowSubmit %}
        <input class="btn--alt" type="submit" value="Push To Selected Servers" name="submit">
    {% endif %}
    </form>

{% endblock %}
