{% extends 'base.html.twig' %}
{% import 'partials/pagination.twig' as pagination %}

{% set page_title = "Push history for " ~ repo.name %}

{% block content %}
    <p><a class="btn--small btn--back" href="{{ urlFor('repository.status', {'id': repo.id}) }}">Back to Repository Status</a></p>

    {% set server = deployment|formatDeploymentServer %}
    {% set deployment_details = deployment|formatDeploymentDetails %}
    {% set deployment_label = deployment|formatDeploymentDetailsLabel %}

    <h2>Push history for <strong>{{ repo.name }}</strong> to <strong>{{ server }}</strong></h2>

    <h3>Deployment Information</h3>
    <div class="details-box">
        <dl class="split--left mbn">

            <dt class="split--left__title">Environment</dt>
            <dd class="split--left__value">
                <a href="{{ urlFor('environment', {'id': deployment.server.environment.id}) }}">{{ deployment.server.environment.key }}</a>
            </dd>

            <dt class="split--left__title">Server</dt>
            <dd class="split--left__value">
                <a href="{{ urlFor('server', {'id': deployment.server.id}) }}">{{ server }}</a>
            </dd>

            <dt class="split--left__title">{{ deployment_label }}</dt>
            <dd class="split--left__value"><code>{{ deployment_details }}</code></dd>

            {% if deployment.url %}
                <dt class="split--left__title">URL</dt>
                <dd class="split--left__value">
                    <a href="{{ deployment.url.asString }}">{{ deployment.url.asString }}</a>
                </dd>
            {% endif %}
        </dl>
    </div>

    <p>
        This table shows the push history for this deployment.
        To rollback, simply choose a build, click <strong>rollback</strong>, and you'll be able to initate a new push.
    </p>

    {% set canRollback = canUserPush(currentUser, repo.key, deployment.server.environment.key) %}

    <h3>Push History</h3>
    <table data-tablesaw-mode="stack">
        <thead>
            <th>Build</th>
            <th>Status</th>
            <th>Reference</th>
            <th>Commit</th>
            <th>Pushed</th>
            <th>Initiator</th>
            {% if canRollback %}
                <th class="t10"></th>
            {% endif %}
        </thead>
        <tbody>
            {% for push in pushes %}
            <tr>
                <td><a href="{{ urlFor('build', {'build': push.build.id}) }}">{{ push.build.id|formatBuildId }}</a></td>
                <td>
                    {% if push.status == 'Success' %}
                        <span class="status-before--success">{{ push.status }}</span>
                    {% elseif push.status == 'Error' %}
                        <span class="status-before--error">{{ push.status }}</span>
                    {% else %}
                        <span class="status-before--other">{{ push.status }}</span>
                    {% endif %}
                </td>

                <td>
                    <a href="{{ githubReference(push.build.repository.githubUser, push.build.repository.githubRepo, push.build.branch) }}">{{ push.build.branch|gitref }}</a>
                    <svg class="icon"><use xlink:href="#fork"></use></svg>
                </td>
                <td>
                    <a href="{{ githubCommit(push.build.repository.githubUser, push.build.repository.githubRepo, push.build.commit) }}">{{ push.build.commit|commit }}</a>
                    <svg class="icon"><use xlink:href="#github"></use></svg>
                </td>
                <td>{{ push.end|reldate }} (Push <a href="{{ urlFor('push', {'push': push.id}) }}">{{ push.id|formatPushId }}</a>)</td>
                <td>
                    {% if push.user %}
                        <a href="{{ urlFor('user', {'id': push.user.id}) }}">{{ push.user.handle }}</a>
                    {% elseif push.consumer %}
                        {{ push.consumer.name|sliceString }}
                    {% else %}
                        Unknown
                    {% endif %}
                </td>

                {% if canRollback %}
                    <td>
                        {% if push.build.status == 'Removed' %}
                            Removed
                        {% elseif push.status == 'Success'%}
                            <a class="btn btn--tiny" href="{{ urlFor('push.start', {'build': push.build.id}, {deployment: deployment.id}) }}">Rollback</a>
                        {% endif %}
                    </td>
                {% endif %}
            </tr>
            {% else %}
            <tr>
                <td colspan="{{ canRollback ? 6 : 5 }}">
                    There is no push history for this deployment.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {{ pagination.pagination(page, last, 'rollback', {'id': repo.id, 'deployment': deployment.id}) }}

{% endblock %}
