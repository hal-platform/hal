imports:
  - resource: di.pages.yml
  - resource: di.api.yml

parameters:
    # environment independent parameters
    slim.hooks:
        slim.before:
            - 'slim.hook.logger'
            - 'slim.hook.errors'
            - 'slim.hook.twig'
        slim.before.router:
            - 'slim.hook.routes'
    applicationId: '200947'

services:

  ######################################################################################################################
  # RUN TIME INJECTED (SYNTHETIC) SERVICES
  ######################################################################################################################

  # This is set by LoginBouncer
  user:
    class: 'MCP\Corp\Account\User'
    synthetic: true

  service_container:
    class: 'Symfony\Component\DependencyInjection\ContainerInterface'
    synthetic: true

  ######################################################################################################################
  # DOCTRINE CONFIGURATION
  ######################################################################################################################

  doctrine.config:
    class: 'Doctrine\ORM\Configuration'
    factory_class: 'Doctrine\ORM\Tools\Setup'
    factory_method: 'createAnnotationMetadataConfiguration'
    arguments:
      - ['@doctrine.mapping']
      - %doctrine.devmode%
      - @doctrine.proxy.dir

  doctrine.proxy.dir:
    class: 'NOTHING_TO_SEE_HERE'
    factory_service: 'directory.helper'
    factory_method: 'fullPath'
    arguments:
      - 'app/cache/doctrine/proxy'

  doctrine.events:
    class: 'Doctrine\Common\EventManager'
    calls:
      - ['addEventListener', [['onFlush'], @doctrine.logger]]
      - ['addEventListener', [['prePersist'], @doctrine.persist.listener]]

  doctrine.logger:
    class: 'QL\Hal\Logger\DoctrineEntityLogger'
    arguments:
      - @user.helper

  doctrine.persist.listener:
    class: 'QL\Hal\Core\Entity\Listener\EntityPersistListener'
    arguments:
      - @clock

  ######################################################################################################################
  # APPLICATION
  ######################################################################################################################

  slim:
    class: 'Slim\Slim'
    arguments:
      - debug: '%debug%'
      - log.writer: '@slim.logger'
    configurator: ['@slim.configurator', 'configure']

  slim.environment:
    class: 'Slim\Environment'
    factory_service: 'slim'
    factory_method: 'environment'
  slim.request:
    class: 'Slim\Http\Request'
    factory_service: 'slim'
    factory_method: 'request'
  slim.response:
    class: 'Slim\Http\Response'
    factory_service: 'slim'
    factory_method: 'response'
  slim.router:
    class: 'Slim\Router'
    factory_service: 'slim'
    factory_method: 'router'

  slim.configurator:
    class: 'QL\Hal\Slim\SlimConfigurator'
    arguments: ['@service_container', '%slim.hooks%']

  slim.hook.routes:
    class: 'QL\Hal\Slim\RouteLoaderHook'
    arguments: ['@service_container', '%routes%']
  slim.hook.logger:
    class: 'QL\Hal\Slim\McpLoggerHook'
    arguments: ['@logger.mcp.factory', '@slim.environment']
  slim.hook.errors:
    class: 'QL\Hal\Slim\ErrorHandlerHook'
    arguments: ['@logger', '%debug%', '@error.pages.twig']
  slim.hook.twig:
    class: 'QL\Hal\Slim\TwigEnvironmentHook'
    arguments: ['@twigEnv', '@session']

  slim.logger:
    class: 'QL\Hal\Logger\McpLogWriter'
    arguments: ['@logger']

  ######################################################################################################################
  # HELPERS
  ######################################################################################################################

  url.helper:
    class: 'QL\Hal\Helpers\UrlHelper'
    arguments:
      - @slim.request
      - @slim.response
      - @slim.router
      - @github

  directory.helper:
    class: 'QL\Hal\Helpers\DirectoryHelper'
    arguments:
      - %root%

  user.helper:
    class: 'QL\Hal\Helpers\LazyUserHelper'
    arguments:
      - @service_container

  api.helper:
    class: 'QL\Hal\Helpers\ApiHelper'
    arguments:
      - @url.helper

  time.helper:
    class: 'QL\Hal\Helpers\TimeHelper'

  clock:
    class: 'MCP\DataType\Time\Clock'
    arguments: ['now', 'UTC']

  ######################################################################################################################
  # TWIG STUFF
  ######################################################################################################################

  # HAL Twig Extension
  twigExtension:
    class: 'QL\Hal\Twig\HalExtension'
    arguments:
      - @permissions
      - @url.helper
      - @github
      - @time.helper

  # Twig Loader
  twigLoader:
    class: 'Twig_Loader_Filesystem'
    arguments:
      - '%root%/app/templates'

  # Twig Environment
  twigEnv:
    class: 'Twig_Environment'
    arguments: ['@twigLoader']
    calls:
      - ['addExtension', ['@twigExtension']]

  layout:
    class: 'QL\Hal\Layout'
    arguments:
      - @user
      - @permissions

  # The primary twig template. All other twig services should use this service as a parent
  twig.template:
    class: 'Twig_Template'
    factory_service: 'twigEnv'
    factory_method: 'loadTemplate'

  ######################################################################################################################
  # BOUNCERS
  ######################################################################################################################

  # Bounce unauthenticated users
  login.bouncer:
    class: 'QL\Hal\Bouncers\LoginBouncer'
    arguments:
      - @session
      - @service_container
      - @url.helper

  # Bounce non-admins
  admin.bouncer:
    class: 'QL\Hal\Bouncers\AdminBouncer'
    arguments:
      - @session
      - @permissions
      - @twigEnv

  ######################################################################################################################
  # NON-DATABASE SERVICES
  ######################################################################################################################

  ldapTransport:
    class: 'Zend\Ldap\Ldap'
    arguments:
      - 'host': '%ldap.host%'
        'baseDn': '%ldap.baseDn%'
        'accountDomainNameShort': '%ldap.domain%'

  ldapService:
    class: 'MCP\Corp\Account\QLAdService'
    arguments:
      - @ldapTransport
    calls:
      - ['authenticate', ['%ldap.username%', '%ldap.password%', false]]

  cache:
    class: 'MCP\Cache\MemoryCache'

  permissions:
    class: 'QL\Hal\Services\PermissionsService'
    arguments:
      - @ldapService
      - @deployment.repo
      - @repository.repo
      - @user.repo
      - @environment.repo
      - @github
      - @cache
      - '%debug.godmode%'

  ######################################################################################################################
  # API Helpers
  ######################################################################################################################

  api.build.normalizer:
    class: 'QL\Hal\Api\BuildNormalizer'
    arguments:
        - @api.helper
        - @url.helper
        - @time.helper
        - @api.environment.normalizer
        - @api.repository.normalizer
        - @api.user.normalizer

  api.push.normalizer:
    class: 'QL\Hal\Api\PushNormalizer'
    arguments:
        - @api.helper
        - @url.helper
        - @time.helper
        - @api.build.normalizer
        - @api.deployment.normalizer
        - @api.user.normalizer

  api.deployment.normalizer:
    class: 'QL\Hal\Api\DeploymentNormalizer'
    arguments:
        - @api.helper
        - @api.repository.normalizer
        - @api.server.normalizer

  api.environment.normalizer:
    class: 'QL\Hal\Api\EnvironmentNormalizer'
    arguments:
        - @api.helper
        - @url.helper

  api.group.normalizer:
    class: 'QL\Hal\Api\GroupNormalizer'
    arguments:
        - @api.helper
        - @url.helper

  api.repository.normalizer:
    class: 'QL\Hal\Api\RepositoryNormalizer'
    arguments:
        - @api.helper
        - @url.helper
        - @api.group.normalizer

  api.server.normalizer:
    class: 'QL\Hal\Api\ServerNormalizer'
    arguments:
        - @api.helper
        - @url.helper
        - @api.environment.normalizer

  api.user.normalizer:
    class: 'QL\Hal\Api\UserNormalizer'
    arguments:
        - @api.helper
        - @url.helper

  ######################################################################################################################
  # Github API
  ######################################################################################################################

  github:
    class: 'QL\Hal\Services\GithubService'
    arguments:
      - '@github.userService'
      - '@github.repoService'
      - '@github.refService'
      - '@github.pullService'
      - '@github.commitService'
      - '@github.pager'
      - @github.commitRepo

  github.client:
    class: 'Github\Client'
    arguments: ['@github.httpClient']

  github.httpClient:
    class: 'QL\Hal\GithubApi\HackCachedHttpClient'
    arguments:
      - {base_url: '%github.baseurl%'}
    calls:
      - ['authenticate', ['%github.token%', null, 'http_token']]

  github.pager:
    class: 'Github\ResultPager'
    arguments:
      - @github.client

  github.orgService:
    class: 'Github\Api\Organization'
    arguments:
      - @github.client

  github.pullService:
    class: 'Github\Api\PullRequest'
    arguments:
      - @github.client

  github.refService:
    class: 'Github\Api\GitData\References'
    arguments:
      - @github.client

  github.commitService:
      class: 'Github\Api\GitData\Commits'
      arguments:
        - @github.client

  github.repoService:
    class: 'Github\Api\Repo'
    arguments:
      - @github.client

  github.userService:
    class: 'QL\Hal\GithubApi\HackUser'
    arguments:
      - @github.client

  github.commitRepo:
    class: 'Github\Api\Repository\Commits'
    arguments:
      - @github.client

  ######################################################################################################################
  # SESSION
  ######################################################################################################################

  sessionHandler:
    class: 'QL\Hal\Services\Session\Handler\DoctrineHandler'
    arguments:
      - @session.repo
      - @doctrine.em

  session:
    class: 'QL\Hal\Session'
    arguments:
      - @sessionHandler

  ######################################################################################################################
  # Logging
  ######################################################################################################################

  logger:
    class: 'MCP\Service\Logger\Logger'
    arguments: ['@logger.mcp.service', '@logger.mcp.factory']

  logger.mcp.service:
    class: 'MCP\Service\Logger\Service\GuzzleService'
    arguments: ['@logger.mcp.guzzle', '@logger.mcp.renderer', true]
  logger.mcp.guzzle:
    class: 'Guzzle\Http\Client'
    arguments: ['%logger.mcp.host%']
  logger.mcp.renderer:
    class: 'MCP\Service\Logger\Renderer\XmlRenderer'
    arguments: ['@logger.mcp.writer']
  logger.mcp.writer:
    class: 'XMLWriter'

  logger.mcp.factory:
    class: 'MCP\Service\Logger\Adapter\Psr\MessageFactory'
    arguments: ['@clock']
    calls:
      - ['setDefaultProperty', ['applicationId', '%applicationId%']]
      # replaced at runtime, maybe
      - ['setDefaultProperty', ['machineIPAddress', '@logger.mcp.serverIp']]
      # replaced at runtime
      - ['setDefaultProperty', ['machineName', 'localhost']]
  logger.mcp.serverIp:
    class: 'MCP\DataType\IPv4Address'
    factory_class: 'MCP\DataType\IPv4Address'
    factory_method: 'create'
    arguments: ['0.0.0.0']
