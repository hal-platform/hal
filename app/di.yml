services:

  ######################################################################################################################
  # APPLICATION
  ######################################################################################################################

  slim:
    class: 'Slim\Slim'
    arguments:
      - debug: '%debug%'
      - log.writer: '@mcpLogger.slimLogWriter'
    calls:
      - ['hook', ['slim.before', '@mcpLogger.factory.setup', 0]]

  slim.environment:
    class: 'Slim\Environment'
    factory_service: 'slim'
    factory_method: 'environment'

  slim.request:
    class: 'Slim\Http\Request'
    factory_service: 'slim'
    factory_method: 'request'

  slim.response:
    class: 'Slim\Http\Response'
    factory_service: 'slim'
    factory_method: 'response'

  slim.router:
    class: 'Slim\Router'
    factory_service: 'slim'
    factory_method: 'router'

  # This is set by LoginBouncer
  user:
    class: 'MCP\Corp\Account\User'
    synthetic: true

  ######################################################################################################################
  # HELPERS
  ######################################################################################################################

  url.helper:
    class: 'QL\Hal\Helpers\UrlHelper'
    arguments:
      - @slim.request
      - @slim.response
      - @slim.router

  ######################################################################################################################
  # TWIG STUFF
  ######################################################################################################################

  # HAL Twig Extension
  twigExtension:
    class: 'QL\Hal\Twig\HalExtension'
    arguments:
      - @pushPermissionService
      - @url.helper

  # Twig Loader
  twigLoader:
    class: 'Twig_Loader_Filesystem'
    arguments:
      - "%root%/app/templates"

  # Twig Environment
  twigEnv:
    class: 'Twig_Environment'
    arguments:
      - @twigLoader
    calls:
      - [addExtension, [@twigExtension]]

  # Twig View for Slim
  twigView:
    class: 'QL\Hal\TwigView'
    arguments:
      - @twigEnv

  layout:
    class: 'QL\Hal\Layout'
    arguments:
      - @user
      - @pushPermissionService

  ######################################################################################################################
  # BOUNCERS
  ######################################################################################################################

  # Bounce unauthenticated users
  login.bouncer:
    class: 'QL\Hal\Bouncers\LoginBouncer'
    arguments:
      - @session
      - @dic
      - @url.helper

  # Bounce non-admins
  admin.bouncer:
    class: 'QL\Hal\Bouncers\AdminBouncer'
    arguments:
      - @session
      - @pushPermissionService
      - @twigEnv

  ######################################################################################################################
  # NON-DATABASE SERVICES
  ######################################################################################################################

  ldapTransport:
    class: 'Zend\Ldap\Ldap'
    arguments:
      - 'host': '%ldap.host%'
        'baseDn': '%ldap.baseDn%'
        'accountDomainNameShort': '%ldap.domain%'

  ldapService:
    class: 'MCP\Corp\Account\QLAdService'
    arguments:
      - @ldapTransport
    calls:
      - ['authenticate', ['%ldap.username%', '%ldap.password%', false]]

  pushPermissionService:
    class: 'QL\Hal\PushPermissionService'
    arguments:
      - '@ldapService'
      - @deployment.repo
      - @repository.repo
      - @user.repo
      - '@github'
      - '%debug.godmode%'

  ######################################################################################################################
  # Github API
  ######################################################################################################################

  github:
    class: 'QL\Hal\Services\GithubService'
    arguments:
      - '@github.userService'
      - '@github.repoService'
      - '@github.refService'
      - '@github.pullService'
      - '@github.pager'

  github.client:
    class: 'Github\Client'
    arguments:
      - @github.httpClient

  github.httpClient:
    class: 'QL\Hal\GithubApi\HackCachedHttpClient'
    arguments:
      - {base_url: '%github.baseurl%'}
    calls:
      - ['authenticate', ['%github.token%', null, 'http_token']]

  # Using the filesystem as a cache causes issues because of the different users involve here.
  # - The web front end runs with a user that can RW to /tmp, but not /var/spool/hal9000[test]
  # - The pusher script runs with a different user that can't RW to /tmp, but CAN RW to /var/spool/hal9000[test]
  # In instances where the filesystem is unavailable, set the memory cache on the http client.
  # Perhaps redis/apcu would be a better long term solution.
  github.memory-cache:
    class: 'QL\Hal\GithubApi\InMemoryCache'

  github.pager:
    class: 'Github\ResultPager'
    arguments:
      - @github.client

  github.orgService:
    class: 'Github\Api\Organization'
    arguments:
      - @github.client

  github.pullService:
    class: 'Github\Api\PullRequest'
    arguments:
      - @github.client

  github.refService:
    class: 'Github\Api\GitData\References'
    arguments:
      - @github.client

  github.repoService:
    class: 'Github\Api\Repo'
    arguments:
      - @github.client

  github.userService:
    class: 'QL\Hal\GithubApi\HackUser'
    arguments:
      - @github.client

  ######################################################################################################################
  # PAGE LAYOUTS & CONTROLLERS
  ######################################################################################################################

  ## TEMP
  nyi.twig:
    class: "Twig_Template"
    arguments:
      - 'nyi.twig'
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  ## TEMP
  nyi.page:
    class: "QL\\Hal\\Controllers\\NyiController"
    arguments:
      - @nyi.twig

  hello.twig:
    class: "Twig_Template"
    arguments:
      - 'hello.twig'
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  hello.page:
    class: "QL\\Hal\\Controllers\\HelloController"
    arguments:
      - @hello.twig
      - @layout
      - @user

  login.twig:
    class: "Twig_Template"
    arguments:
      - 'login.twig'
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  login.page:
    class: "QL\\Hal\\Controllers\\LoginController"
    arguments:
      - @login.twig

  login.handle:
    class: "QL\\Hal\\Controllers\\LoginHandleController"
    arguments:
      - @login.twig
      - @ldapService
      - @user.repo
      - @doctrine.em
      - @session
      - @url.helper

  logout.handle:
    class: "QL\\Hal\\Controllers\\LogoutController"
    arguments:
      - @session
      - @url.helper

  profile.twig:
    class: "Twig_Template"
    arguments:
      - 'profile.twig'
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  profile.edit.twig:
    class: 'Twig_Template'
    arguments:
      - 'profile.edit.twig'
    factory_service: 'twigEnv'
    factory_method: 'loadTemplate'

  profile.page:
    class: 'QL\Hal\Controllers\User\ProfileController'
    arguments:
      - @profile.twig
      - @layout
      - @pushPermissionService
      - @ldapService
      - @user.repo
      - @user
      - @doctrine.em
  profile.edit.page:
    class: 'QL\Hal\Controllers\User\EditProfileController'
    arguments:
      - @profile.edit.twig
      - @layout
      - @pushPermissionService
      - @ldapService
      - @user.repo
      - @doctrine.em
      - @url.helper

  groups.twig:
    class: "Twig_Template"
    arguments:
      - 'groups.twig'
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  groups.page:
    class: "QL\\Hal\\Controllers\\GroupsController"
    arguments:
      - @groups.twig
      - @layout
      - @group.repo

  group.twig:
    class: "Twig_Template"
    arguments:
      - 'group.twig'
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  group.page:
    class: "QL\\Hal\\Controllers\\Group\\GroupController"
    arguments:
      - @group.twig
      - @layout
      - @group.repo
      - @repository.repo

  repository.twig:
    class: "Twig_Template"
    arguments:
      - "repository.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  repository.page:
    class: "QL\\Hal\\Controllers\\Repository\\RepositoryController"
    arguments:
      - @repository.twig
      - @layout
      - @pushPermissionService
      - @doctrine.em
      - @repository.repo
      - @build.repo
      - @push.repo
      - @user

  repository.push.history.twig:
    class: "Twig_Template"
    arguments:
      - "repository.push.history.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  repository.push.history.page:
    class: "QL\\Hal\\Controllers\\Repository\\Push\\HistoryController"
    arguments:
      - @repository.push.history.twig
      - @layout
      - @doctrine.em
      - @repository.repo
      - @push.repo

  repository.build.history.twig:
    class: "Twig_Template"
    arguments:
      - "repository.build.history.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  repository.build.history.page:
    class: "QL\\Hal\\Controllers\\Repository\\Build\\HistoryController"
    arguments:
      - @repository.build.history.twig
      - @layout
      - @doctrine.em
      - @repository.repo
      - @build.repo
      - @user

  repository.build.start.twig:
    class: "Twig_Template"
    arguments:
      - "repository.build.start.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  repository.build.start.page:
    class: "QL\\Hal\\Controllers\\Repository\\Build\\BuildStartController"
    arguments:
      - @repository.build.start.twig
      - @layout
      - @repository.repo
      - @environment.repo
      - @github

  repository.build.start.handle.page:
    class: "QL\\Hal\\Controllers\\Repository\\Build\\BuildStartHandleController"
    arguments:
      - @repository.repo
      - @user.repo
      - @url.helper
      - @user

  rollback.twig:
    class: "Twig_Template"
    arguments:
      - "rollback.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  rollback.page:
    class: "QL\\Hal\\Controllers\\Repository\\RollbackController"
    arguments:
      - @rollback.twig
      - @layout
      - @repository.repo
      - @server.repo
      - @doctrine.em
      - @user

  build.twig:
    class: "Twig_Template"
    arguments:
      - "build.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  build.page:
    class: "QL\\Hal\\Controllers\\Repository\\Build\\BuildController"
    arguments:
      - @build.twig
      - @layout
      - @build.repo

  push.twig:
    class: "Twig_Template"
    arguments:
      - "push.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  push.page:
    class: "QL\\Hal\\Controllers\\Repository\\Push\\PushController"
    arguments:
      - @push.twig
      - @layout
      - @push.repo

  server.twig:
    class: "Twig_Template"
    arguments:
      - "server.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  server.page:
    class: "QL\\Hal\\Controllers\\Server\\ServerController"
    arguments:
      - @server.twig
      - @layout
      - @server.repo
      - @deployment.repo

  servers.twig:
    class: "Twig_Template"
    arguments:
      - "servers.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  servers.page:
    class: "QL\\Hal\\Controllers\\Server\\ServersController"
    arguments:
      - @servers.twig
      - @layout
      - @server.repo

  build.push.twig:
    class: "Twig_Template"
    arguments:
      - "build.push.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  build.push.page:
    class: "QL\\Hal\\Controllers\\Repository\\Push\\BuildPushController"
    arguments:
      - @build.push.twig
      - @layout
      - @doctrine.em
      - @build.repo
      - @user

  ######################################################################################################################
  # ADMIN PAGE LAYOUTS & CONTROLLERS
  ######################################################################################################################

  admin.repos.twig:
    class: "Twig_Template"
    arguments:
      - "admin/repositories.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  admin.repos.page:
    class: "QL\\Hal\\Controllers\\Admin\\RepositoriesController"
    arguments:
      - @admin.repos.twig
      - @layout
      - @repository.repo

  admin.groups.twig:
    class: "Twig_Template"
    arguments:
      - "admin/groups.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  admin.groups.page:
    class: "QL\\Hal\\Controllers\\Admin\\GroupsController"
    arguments:
      - @admin.groups.twig
      - @layout
      - @group.repo

  admin.servers.twig:
    class: "Twig_Template"
    arguments:
      - "admin/servers.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  admin.servers.page:
    class: "QL\\Hal\\Controllers\\Admin\\ServersController"
    arguments:
      - @admin.servers.twig
      - @layout
      - @server.repo

  admin.envs.twig:
    class: "Twig_Template"
    arguments:
      - "admin/environments.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  admin.envs.page:
    class: "QL\\Hal\\Controllers\\Admin\\EnvironmentsController"
    arguments:
      - @admin.envs.twig
      - @layout
      - @environment.repo

  admin.users.twig:
    class: "Twig_Template"
    arguments:
      - "admin/users.twig"
    factory_service: "twigEnv"
    factory_method: "loadTemplate"

  admin.users.page:
    class: "QL\\Hal\\Controllers\\Admin\\UsersController"
    arguments:
      - @admin.users.twig
      - @layout
      - @user.repo

  static.controller:
    class: 'QL\Hal\Controllers\StaticController'

  denied.page:
    parent: 'static.controller'
    arguments: ['@denied.twig']
  denied.twig:
    class: 'Twig_Template'
    arguments:
      - 'denied.html.twig'
    factory_service: 'twigEnv'
    factory_method: 'loadTemplate'

  ######################################################################################################################
  # API CONTROLLERS
  ######################################################################################################################



  ######################################################################################################################
  # SESSION
  ######################################################################################################################

  sessionHandler:
    class: 'QL\Hal\Services\Session\Handler\DoctrineHandler'
    arguments:
      - @session.repo
      - @doctrine.em

  session:
    class: 'QL\Hal\Session'
    arguments:
      - @sessionHandler

  ######################################################################################################################
  # PUSHER COMMAND
  ######################################################################################################################


  ######################################################################################################################
  # Build Notifications & Logging
  ######################################################################################################################

  # Mailer Transport
  buildMailerTransport:
    class: 'Swift_SmtpTransport'
    arguments:
      - "%email.hostname%"

  # Mailer
  buildMailer:
    class: 'Swift_Mailer'
    arguments:
      - @buildMailerTransport

  # Sample Message
  buildMessage:
    class: "QL\\Hal\\Mail\\Message"
    arguments:
      - "%email.subject%"
      - ["%email.notify%"]
      - ["%email.notify.error%"]

  # Log Sub Handler
  buildLogSubHandler:
    class: "Monolog\\Handler\\SwiftMailerHandler"
    arguments:
      - @buildMailer
      - @buildMessage
      - "%build.log.level%"
    calls:
      - ["setFormatter", [@buildLogFormatter]]

  # HTML Formatter
  buildLogFormatter:
    class: "QL\\Hal\\Mail\\Formatter\\HtmlFormatter"

  # Log Handler
  buildLogHandler:
    class: "Monolog\\Handler\\BufferHandler"
    arguments:
      - @buildLogSubHandler

  # Logger
  buildLogger:
    class: "Monolog\\Logger"
    arguments:
      - "%build.log.name%"
      - [@buildLogHandler]

  # MCP Logger
  mcpLogger.slimLogWriter:
    class: 'QL\Hal\Logger\McpLogWriter'
    arguments:
      - @mcpLogger

  mcpLogger:
    class: 'MCP\Service\Logger\Logger'
    arguments:
      - @mcpLogger.service
      - @mcpLogger.factory

  mcpLogger.service:
    class: 'MCP\Service\Logger\Service\GuzzleService'
    arguments:
      - @mcpLogger.guzzle
      - @mcpLogger.renderer
      - true

  mcpLogger.guzzle:
    class: 'Guzzle\Http\Client'
    arguments:
      - 'http://%mcpLogger.host%:2581/web/core/logentries'

  mcpLogger.renderer:
    class: 'MCP\Service\Logger\Renderer\XmlRenderer'
    arguments:
      - @mcpLogger.renderer.writer

  mcpLogger.renderer.writer:
    class: 'XMLWriter'

  mcpLogger.factory:
    class: 'MCP\Service\Logger\Adapter\Psr\MessageFactory'
    arguments:
      - @mcpLogger.factory.clock
    calls:
      - ['setDefaultProperty', ['applicationId', '%mcpLogger.applicationId%']]
      - ['setDefaultProperty', ['machineIPAddress', '@mcpLogger.factory.serverIp']]
      - ['setDefaultProperty', ['machineName', 'localhost']]

  mcpLogger.factory.clock:
    class: 'MCP\DataType\Time\Clock'
    arguments:
      - 'now'
      - 'UTC'

  mcpLogger.factory.setup:
    class: 'QL\Hal\Logger\McpSetupHook'
    arguments:
      - @mcpLogger.factory
      - @dic

  mcpLogger.factory.serverIp:
    class: 'MCP\DataType\IPv4Address'
    factory_class: 'MCP\DataType\IPv4Address'
    factory_method: 'create'
    arguments:
      - '0.0.0.0'
