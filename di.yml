services:

  # Twig stuff
  twigLoader:
    class: "Twig_Loader_Filesystem"
    arguments: ["%root%/templates"]
  twigEnv:
    class: "Twig_Environment"
    arguments: ["@twigLoader"]

  session: { class: 'QL\Hal\Session' }
  # DB related services
  db:
    class: "PDO"
    arguments: ["%db.dsn%", "%db.user%", "%db.pass%"]
    calls: [["setAttribute", [3, 2]]] # PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION
  repoService:
    class: "QL\\Hal\\Services\\RepositoryService"
    arguments: ["@db"]
  serverService:
    class: "QL\\Hal\\Services\\ServerService"
    arguments: ["@db"]
  deploymentService:
    class: "QL\\Hal\\Services\\DeploymentService"
    arguments: ["@db"]
  userService:
    class: "QL\\Hal\\Services\\UserService"
    arguments: ["@db"]
  envService:
    class: "QL\\Hal\\Services\\EnvironmentService"
    arguments: ["@db"]
  arrService:
    class: "QL\\Hal\\Services\\ArrangementService"
    arguments: ["@db"]
  logService:
    class: "QL\\Hal\\Services\\LogService"
    arguments: ["@db"]
  syncOptions:
    class: "QL\\Hal\\Services\\SyncOptions"
    arguments: ["@repoService", "@deploymentService", "@githubRepoService"]

  # Non-db services
  ldapService:
    class: "MCP\\Corp\\Account\\LdapService"

  github:
    class: "Github\\Client"
    calls:
      - ["setOption",    ["base_url", "%github.baseurl%"]]
      - ["authenticate", ["%github.token%", null, "http_token"]] # Github\Client::AUTH_HTTP_TOKEN
  githubRepoService:
    class: "Github\\Api\\Repo"
    factory_service: "github"
    factory_method: "api"
    arguments: ["repo"]

  loginGuard: { class: 'QL\Hal\LoginGuard', arguments: ['@session'] }

  # Pages
  login.twig: { arguments: ["login.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  loginPage:
    class: "QL\\Hal\\LoginPage"
    arguments: ["@login.twig"]
  loginHandler:
    class: "QL\\Hal\\LoginHandler"
    arguments: ["@session", "@ldapService", "@login.twig", "@userService"]

  logoutPage: { class: 'QL\Hal\LogoutPage' }

  users.twig: { arguments: ["users.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  userPage:
    class: "QL\Hal\Users"
    arguments: ["@users.twig", "@userService"]

  arrangement-list.twig: { arguments: ["arrangement-list.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  arrangementListPage:
    class: 'QL\Hal\ArrangementListPage'
    arguments: ["@arrangement-list.twig", "@arrService"]

  arrangement.twig: { arguments: ["arrangement.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  arrangementPage:
    class: 'QL\Hal\ArrangementPage'
    arguments: ["@arrangement.twig", "@arrService", "@repoService"]

  repository.twig: { arguments: ["repository.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  repositoryPage:
    class: 'QL\Hal\RepositoryPage'
    arguments: ["@repository.twig", "@repoService", "@deploymentService", "@serverService", "@logService"]

  admin.dashboard.twig: { arguments: ["admin/dashboard.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  adminDashboardPage:
    class: 'QL\Hal\Admin\Dashboard'
    arguments: ["@admin.dashboard.twig", "@repoService", "@userService"]

  admin.repositories.twig: { arguments: ["admin/repositories.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  adminRepositoriesPage:
    class: 'QL\Hal\Admin\ManageRepositories'
    arguments: ["@admin.repositories.twig", "@repoService", "@arrService"]
  adminRepositoriesHandler:
    class: 'QL\Hal\Admin\ManageRepositoriesHandler'
    arguments: ["@admin.repositories.twig", "@repoService", "@arrService"]

  admin.servers.twig: { arguments: ["admin/servers.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  adminServersPage:
    class: 'QL\Hal\Admin\ManageServers'
    arguments: ["@admin.servers.twig", "@serverService", "@envService"]
  adminServersHandler:
    class: 'QL\Hal\Admin\ManageServersHandler'
    arguments: ["@admin.servers.twig", "@serverService", "@envService"]

  admin.deployments.twig: { arguments: ["admin/deployments.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  adminDeploymentsPage:
    class: 'QL\Hal\Admin\ManageDeployments'
    arguments: ["@admin.deployments.twig", "@repoService", "@serverService", "@deploymentService"]
  adminDeploymentsHandler:
    class: "QL\Hal\Admin\ManageDeploymentsHandler"
    arguments: ["@admin.deployments.twig", "@repoService", "@serverService", "@deploymentService"]

  admin.arrangements.twig: { arguments: ["admin/arrangements.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  adminArrangementsPage:
    class: 'QL\Hal\Admin\ManageArrangements'
    arguments: ["@admin.arrangements.twig", "@arrService"]
  adminArrangementsHandler:
    class: 'QL\Hal\Admin\ManageArrangementsHandler'
    arguments: ["@admin.arrangements.twig", "@arrService"]

  admin.environments.twig: { arguments: ["admin/environments.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  adminEnvironmentsPage:
    class: 'QL\Hal\Admin\ManageEnvironments'
    arguments: ["@admin.environments.twig", "@envService"]
  adminEnvironmentsHandler:
    class: 'QL\Hal\Admin\ManageEnvironmentsHandler'
    arguments: ["@admin.environments.twig", "@envService"]

  admin.users.twig: { arguments: ["admin/users.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  adminUsersPage:
    class: 'QL\Hal\Admin\ManageUsers'
    arguments: ["@admin.users.twig", "@userService"]

  sync-code.twig: { arguments: ["sync-code.twig"], class: "Twig_Template", factory_service: "twigEnv", factory_method: "loadTemplate" }
  syncPage:
    class: 'QL\Hal\SyncPage'
    arguments: ["@sync-code.twig", "@syncOptions"]
  syncHandler:
    class: 'QL\Hal\SyncHandler'
    arguments:
      - "@sync-code.twig"
      - "@syncOptions"
      - "@logService"
      - "@deploymentService"
      - "@session"
      - "%root%/bin/pusher.php"
      - "%build.user%"
      - "%rsync.user%"
      - true
