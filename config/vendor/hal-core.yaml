parameters:
    ############################################################################
    # RUNTIME CONFIGURATION
    ############################################################################

    env(HAL_ORM_CACHE): 'memory'
    env(HAL_ORM_DEVMODE_ON): false
    env(HAL_ORM_PROXY_DIR): '.doctrine'

    doctrine.dev_mode: '%env(HAL_ORM_DEVMODE_ON)%'
    doctrine.proxy_dir: '%env(HAL_ORM_PROXY_DIR)%'

    doctrine.cache.type: '%env(HAL_ORM_CACHE)%'

    doctrine.connection:
        user:       '%env(HAL_DB_USER)%'
        password:   '%env(HAL_DB_PASSWORD)%'
        host:       '%env(HAL_DB_HOST)%'
        port:       '%env(HAL_DB_PORT)%'
        dbname:     '%env(HAL_DB_NAME)%'
        driver:     '%env(HAL_DB_DRIVER)%'

    ############################################################################
    # STATIC CONFIGURATION
    ############################################################################

    doctrine.cache.lvl2_enabled: true
    doctrine.cache.lvl2_ttl: 600
    doctrine.cache.lvl2_lock: 60

    doctrine.cache.ttl: 600

    doctrine.user.service: ''
    doctrine.proxy.connection:
        driver: 'pdo_sqlite'
        memory: true

services:

    ############################################################################
    # DOCTRINE PROXY
    ############################################################################

    doctrine.em.proxy:
        class: 'Doctrine\ORM\EntityManager'
        factory: ['Doctrine\ORM\EntityManager', 'create']
        arguments:
            - '%doctrine.proxy.connection%'
            - '@doctrine.config'
            - '@doctrine.em.event_manager'
        configurator: ['@doctrine.em.configurator', 'configure']

    ############################################################################
    # DOCTRINE PATHS
    ############################################################################

    doctrine.mapping.dir.hal:
        class: 'stdClass'
        factory: ['QL\Hal\Core\Utility\DoctrineFactory', 'configurationPath']

    ############################################################################
    # DOCTRINE EM
    ############################################################################

    doctrine.em:
        class: 'Doctrine\ORM\EntityManager'
        factory: ['Doctrine\ORM\EntityManager', 'create']
        arguments:
            - '%doctrine.connection%'
            - '@doctrine.config'
            - '@doctrine.em.event_manager'
        configurator: ['@doctrine.em.configurator', 'configure']

    doctrine.em.configurator:
        class: 'QL\Hal\Core\Utility\DoctrineConfigurator'
        calls:
            - ['addEntityMappings', ['@doctrine.types.hal']]

    doctrine.em.event_manager:
        class: 'Doctrine\Common\EventManager'
        calls:
            - ['addEventListener', [['onFlush'], '@doctrine.listener.logger']]
            - ['addEventListener', [['prePersist'], '@doctrine.listener.persist']]

    ############################################################################
    # DOCTRINE CONFIG
    ############################################################################

    doctrine.config:
        class: 'Doctrine\ORM\Configuration'
        factory: ['Doctrine\ORM\Tools\Setup', 'createConfiguration']
        arguments:
            - '%doctrine.dev_mode%'
            - '%doctrine.proxy_dir%'
            - '@doctrine.cache'
        calls:
            - ['setMetadataDriverImpl', ['@doctrine.config.driver']]
            - ['setSecondLevelCacheEnabled', ['%doctrine.cache.lvl2_enabled%']]
            - ['setSecondLevelCacheConfiguration', ['@doctrine.cache.lvl2.config']]

    doctrine.config.driver:
        class: 'Doctrine\ORM\Mapping\Driver\SimplifiedYamlDriver'
        arguments: ['@doctrine.mapping.dirs']
        calls:
            - ['setGlobalBasename', ['global']]

    doctrine.mapping.dirs:
        class: 'stdClass'
        factory: ['QL\Hal\Core\Utility\DoctrineFactory', 'buildConfigurationMapping']
        arguments:
            - ['@doctrine.mapping.dir.hal', 'QL\Hal\Core\Entity']

    ############################################################################
    # LISTENERS
    ############################################################################

    doctrine.clock:
        class: 'QL\MCP\Common\Time\Clock'
        arguments: ['now', 'UTC']

    doctrine.listener.logger:
        class: 'QL\Hal\Core\Listener\DoctrineChangeLogger'
        arguments:
            - '@doctrine.clock'
            - '@doctrine.random'
            - '@doctrine.user'

    doctrine.listener.persist:
        class: 'QL\Hal\Core\Listener\DoctrinePersistListener'
        arguments: ['@doctrine.clock']

    ############################################################################
    # TYPES
    ############################################################################

    doctrine.types.hal:
        class: 'stdClass'
        factory: ['QL\Hal\Core\Utility\DoctrineCustomTypes', 'getMapping']

    ############################################################################
    # DOCTRINE CACHE
    ############################################################################

    doctrine.cache:
        class: 'Doctrine\Common\Cache\Cache'
        factory: ['@service_container', 'get']
        arguments: ['doctrine.cache.%doctrine.cache.type%']

    doctrine.cache.memory:
        class: 'Doctrine\Common\Cache\ArrayCache'

    # second level cache
    doctrine.cache.lvl2.config:
        class: 'Doctrine\ORM\Cache\CacheConfiguration'
        calls:
            - ['setCacheFactory', ['@doctrine.cache.lvl2.factory']]

    doctrine.cache.lvl2.factory:
        class: 'Doctrine\ORM\Cache\DefaultCacheFactory'
        arguments: ['@doctrine.cache.lvl2.region_config', '@doctrine.cache']

    doctrine.cache.lvl2.region_config:
        class: 'Doctrine\ORM\Cache\RegionsConfiguration'
        arguments:
            - '%doctrine.cache.lvl2_ttl%'
            - '%doctrine.cache.lvl2_lock%'

    ############################################################################
    # DOCTRINE HELPERS
    ############################################################################

    doctrine.random:
        class: 'QL\Hal\Core\RandomGenerator'

    doctrine.user:
        class: 'Closure'
        factory: ['@service_container', 'get']
        arguments: ['%doctrine.user.service%']
