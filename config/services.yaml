#
# Definition conventions:
# - If 1-2 arguments, enter on a single line. Otherwise break each argument into its own line.
# - "calls" are always each on a separate line except when defining templates (for readability)
#
# # Naming conventions
#
# - Global middleware:      "slim.global_middleware.*"
# - Page middleware:        "middleware.*"

# - UI Controllers:          "*.page"
# - API Controllers:         "*.api"
# - Redirecting Controllers: "*.handler"

# - Single-page middleware: "*.middleware"
# - Single-page template:   "*.twig"
#
# Example (Page: "Sign In")
#  - 'signin.page'
#  - 'signin.middleware'
#  - 'signin.twig'
#
# - 'middleware.signin' (shared middleware to check if user is signed in)

services:
    notFoundHandler:     { alias: 'panthor.handler.notFoundHandler' }
    notAllowedHandler:   { alias: 'panthor.handler.notAllowedHandler' }
    phpErrorHandler:     { alias: 'panthor.handler.phpErrorHandler' }
    errorHandler:        { alias: 'panthor.handler.errorHandler' }

    ####################################################################################################################
    # SLIM
    ####################################################################################################################

    slim.router.loader:
        parent: 'panthor.router.loader'
        calls:
            # %routes% is auto loaded by parent
            - ['addRoutes', ['%routes.api%']]
            - ['addRoutes', ['%routes.api_internal%']]
            - ['addRoutes', ['%routes.api_writes%']]

    slim.global_middleware:
        class: 'QL\Panthor\Bootstrap\GlobalMiddlewareLoader'
        arguments: ['@service_container', '%global_middleware%']
    slim.global_middleware.logger:
        class: 'Hal\UI\Middleware\LoggerGlobalMiddleware'
        arguments: ['@mcp.logger.factory']
    slim.global_middleware.session:
        class: 'QL\Panthor\Middleware\SessionMiddleware'
        arguments:
            - '@cookie.handler'
            - lifetime: '%session.lifetime%'
    slim.global_middleware.user_session:
        class: 'Hal\UI\Middleware\UserSessionGlobalMiddleware'
        arguments:
            - '@doctrine.em'
            - '@service.authorization'
            - '@uri'
        calls:
            - ['setLoggerMessageFactory', ['@mcp.logger.factory']]
    slim.global_middleware.flash:
        class: 'Hal\UI\Middleware\FlashGlobalMiddleware'
        arguments: ['@cookie.handler']
    slim.global_middleware.template_context:
        class: 'Hal\UI\Middleware\TemplateContextGlobalMiddleware'
        arguments: ['@twig.context']
    slim.global_middleware.srs_business:
        class: 'Hal\UI\Middleware\SrsBusinessGlobalMiddleware'
        arguments: ['@cookie.handler']
    slim.global_middleware.global_banner:
        class: 'Hal\UI\Middleware\SystemSettingsGlobalMiddleware'
        arguments: ['@banner']

    ####################################################################################################################
    # DOMAIN-SPECIFIC SERVICES
    ####################################################################################################################

    banner:
        class: 'Hal\UI\System\GlobalBannerService'
        arguments:
            - '@doctrine.em'
            - '@clock'
            - '@json'

    sticky.environment:
        class: 'Hal\UI\Service\StickyEnvironmentService'
        arguments:
            - '@cookie.handler'
            - '@json'
            - '%cookie.preferences.ttl%'

    service.event_logs:
        class: 'Hal\UI\Service\EventLogService'
        arguments:
            - '@redis'
            - '@json'
            - '@clock'
            - '@doctrine.em'

    job_queue:
        class: 'Hal\UI\Service\JobQueueService'
        arguments: ['@doctrine.em', '@clock']

    ####################################################################################################################
    # HELPERS
    ####################################################################################################################

    utility.time.formatter:
        class: 'Hal\UI\Utility\TimeFormatter'
        arguments: ['@clock', '%date.timezone%']
